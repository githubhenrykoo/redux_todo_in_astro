import{j as o}from"./jsx-dev-runtime.ndqpvE2b.js";import{r as n}from"./index.DKKB-h0h.js";import{f as ee,g as te,h as oe,i as se}from"./index.YVZF4vbw.js";import{s as r,l as P,t as ne,h as re}from"./store.WvhFAbWr.js";import{createClient as ae}from"./client.BqYALPpZ.js";import"./contentSlice.DBLxFn2W.js";typeof window<"u"&&(window.forceSaveReduxState=(k=!1)=>{console.log("Force save called from outside TopBar");const d=r.getState(),x=new CustomEvent("force-save-state",{detail:{state:d,immediate:k}});window.dispatchEvent(x)});const fe=({initialTheme:k})=>{const[d,x]=n.useState(k||"light"),[y,H]=n.useState(!1),[D,w]=n.useState(!1),[N,R]=n.useState(null),[c,M]=n.useState(!0),[W,$]=n.useState(""),[T,f]=n.useState(!1),[L,m]=n.useState({}),[U,V]=n.useState(""),[p,q]=n.useState(!1),u=n.useRef(null),g=async(s,e=!1)=>{if(p){if(console.log("postStateToBackend called",{immediate:e,autoSaveEnabled:c}),u.current!==null&&(console.log("Clearing previous save timeout"),window.clearTimeout(u.current),u.current=null),!e&&c){console.log("Setting debounce timeout for save"),u.current=window.setTimeout(()=>{console.log("Debounce timeout expired, saving state"),C(s,!0)},1e3);return}(e||!c)&&(console.log("Saving immediately without debounce"),C(s,e))}},C=async(s,e=!1)=>{try{w(!0);const i=JSON.stringify(s);if(console.log("saveState called",{stateJsonLength:i.length,lastSavedStateLength:U?U.length:0,force:e}),!e&&i===U){console.log("State unchanged, skipping save"),w(!1);return}console.log("Saving state to backend...",{panelLayout:s.panellayout?.panels?Object.keys(s.panellayout.panels):"none",themeMode:s.theme?.mode||"unknown",todoCount:s.todos?.items?.length||0}),console.log("Making POST request to /api/store-card");const v=await fetch("/api/store-card",{method:"POST",headers:{"Content-Type":"application/json"},body:i});if(!v.ok)throw new Error(`Failed to save state: ${v.statusText}`);const E=await v.json();console.log("State saved successfully:",E),V(i),R(new Date)}catch(i){console.error("Error saving state:",i)}finally{w(!1)}};n.useEffect(()=>{if(q(!0),typeof window>"u")return;const s=r.getState();V(JSON.stringify(s)),console.log("Initial state set for auto-save comparison");const e=s.user;console.log("Initial user state from Redux:",e),e&&e.isAuthenticated&&n.startTransition(()=>{f(!0),m({email:e.profile?.email,email_verified:e.profile?.email_verified,sub:e.profile?.sub})});const i=s.theme?.mode||"light";n.startTransition(()=>{x(i)});const v=r.subscribe(()=>{const t=r.getState().theme?.mode;t&&t!==d&&n.startTransition(()=>{x(t)})}),E=r.subscribe(()=>{const t=r.getState().user;if(console.log("User state updated in Redux:",t),t){const l=!!t.isAuthenticated;l!==T&&n.startTransition(()=>{f(l),m(l?{email:t.profile?.email,email_verified:t.profile?.email_verified,sub:t.profile?.sub}:{})})}}),O=t=>{console.log("Force save event received",t.detail);const{state:l,immediate:j}=t.detail;g(l,j||!0)};window.addEventListener("force-save-state",O);const J=t=>{if(console.log("Custom state change event received:",t.detail),c){const l=r.getState();g(l,!0)}};window.addEventListener("redux-state-change",J);let A=JSON.stringify(r.getState(),Object.keys(r.getState()).sort());const Y=r.subscribe(()=>{const t=r.getState(),l=JSON.stringify(t,Object.keys(t).sort());l!==A&&(console.log("State changed, triggering auto-save"),A=l,c&&g(t))});$("http://localhost:4321/callback");const S=localStorage.getItem("authentik_top_banner_authuser_info"),_=localStorage.getItem("authentik_top_banner_authaccess_token"),h=localStorage.getItem("authentik_top_banner_authid_token");if(console.log("Stored User Info:",{userInfo:S,accessToken:_,idToken:h}),S)try{let t={};try{t=JSON.parse(S)}catch(B){console.warn("Partial or truncated user info, attempting recovery",B);const b=S.match(/^{[^}]*}/);if(b)try{t=JSON.parse(b[0])}catch(I){console.error("Could not recover user info",I),localStorage.removeItem("authentik_top_banner_authuser_info");return}}const l=B=>{try{const I=B.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(I))}catch(b){return console.error("Error decoding JWT",b),{}}},j=_?l(_):{},Z=h?l(h):{},a={...j,...Z,...t,access_token:_,id_token:h},F={isAuthenticated:!0,sub:a.sub||null,email:a.email||null,email_verified:a.email_verified||!1,name:a.name||null,given_name:a.given_name||null,family_name:a.family_name||null,nickname:a.nickname||null,preferred_username:a.preferred_username||null,groups:a.groups||[],picture:a.picture||null,access_token:_,id_token:h,token_type:"Bearer",expires_at:a.exp?new Date(a.exp*1e3).toISOString():null,lastLogin:new Date().toISOString(),theme:"system",language:"en"};console.log("Dispatching Comprehensive Login Payload:",F),r.dispatch(P(F)),n.startTransition(()=>{f(!0),m({email:a.email,email_verified:a.email_verified,sub:a.sub})}),console.log("Login processed successfully")}catch(t){console.error("Error processing user info:",t),localStorage.removeItem("authentik_top_banner_authuser_info")}return setTimeout(()=>{g(r.getState(),!0)},1e3),()=>{v(),Y(),E(),window.removeEventListener("redux-state-change",J),window.removeEventListener("force-save-state",O),u.current!==null&&(console.log("Cleaning up save timeout during component unmount"),window.clearTimeout(u.current),u.current=null)}},[c,T,d]);const z=async()=>{try{H(!0);const s=!0,e=window.location.pathname+window.location.search;await ae({clientId:"SDyvH6sVjZnajkPlyh40jSdWuniXuOERYh1DjLqT",clientSecret:"UWD2qQNsJzRlwuiURmNcJWcnPvi2GKhIujhtDrWVLdPoyy8CDmuHcUyywqhdJHEucV1OSfzacrKUXqmLRVM6e2zJhL9H5qpWfvHncgNm9R0KFawzAbJkhb8pLBiLauMI",redirectUri:W||"",scopes:"openid profile email",baseUrl:"https://auth.pkc.pub",storageKey:"authentik_top_banner_auth"}).login(e)}catch(s){console.error("Login failed:",s),H(!1);{console.log("Development mode: Using mock authentication after error");const e={email:"dev@example.com",email_verified:!0,sub:"dev-user"};localStorage.setItem("authentik_top_banner_authuser_info",JSON.stringify(e));const i={profile:{...e,name:"Dev User",given_name:"Dev",family_name:"User",nickname:"dev",preferred_username:"devuser",groups:["Developers"],picture:null},tokens:{access_token:"mock-access-token",id_token:"mock-id-token",token_type:"Bearer",expires_at:new Date(Date.now()+36e5).toISOString()}};r.dispatch(P(i)),f(!0),m({email:e.email,email_verified:e.email_verified,sub:e.sub})}}},K=()=>{localStorage.removeItem("authentik_top_banner_authuser_info"),localStorage.removeItem("authentik_top_banner_authaccess_token"),localStorage.removeItem("authentik_top_banner_authid_token"),r.dispatch(re()),n.startTransition(()=>{f(!1),m({})})},X=()=>{g(r.getState(),!0)},G=()=>{M(s=>!s)},Q=()=>{if(!N)return"Never saved";const e=new Date().getTime()-N.getTime();if(e<6e4)return"Just now";if(e<36e5){const i=Math.floor(e/6e4);return`${i} minute${i!==1?"s":""} ago`}else return N.toLocaleTimeString()};return o.jsxDEV("div",{className:"w-full h-14 bg-background border-b flex items-center justify-between px-6 shadow-sm",children:[o.jsxDEV("div",{className:"flex items-center space-x-4",children:[o.jsxDEV("h1",{className:"text-xl font-semibold text-foreground",children:"Redux Todo App"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:523,columnNumber:9},void 0),p&&N&&o.jsxDEV("span",{className:"text-xs text-gray-500",children:["Last saved: ",Q()]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:525,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:522,columnNumber:7},void 0),o.jsxDEV("div",{className:"flex items-center space-x-4",children:[p&&T?o.jsxDEV("div",{className:"flex items-center space-x-2",children:[o.jsxDEV("div",{className:"flex flex-col items-end",children:[o.jsxDEV("span",{className:"text-sm font-medium text-foreground",children:L.email},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:534,columnNumber:15},void 0),L.email_verified&&o.jsxDEV("span",{className:"text-xs text-green-600",children:"Verified"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:538,columnNumber:17},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:533,columnNumber:13},void 0),o.jsxDEV("button",{onClick:K,className:"text-red-500 hover:text-red-600","aria-label":"Sign Out",children:o.jsxDEV(ee,{className:"w-5 h-5"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:546,columnNumber:15},void 0)},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:541,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:532,columnNumber:11},void 0):p?o.jsxDEV("button",{onClick:z,disabled:y,className:`
              flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
              ${y?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-100 text-blue-600 hover:bg-blue-200"}
            `,"aria-label":"Sign In",children:y?"Signing In...":"Sign In"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:550,columnNumber:11},void 0):null,p&&o.jsxDEV(o.Fragment,{children:[o.jsxDEV("div",{className:"flex items-center gap-2",children:[o.jsxDEV("button",{onClick:G,className:`
                  flex items-center justify-center px-3 py-1 rounded-full text-xs font-medium
                  ${c?"bg-green-100 text-green-700":"bg-gray-100 text-gray-500"}
                `,"aria-label":c?"Auto-save enabled":"Auto-save disabled",title:c?"Click to disable auto-save":"Click to enable auto-save",children:c?"Auto-save ON":"Auto-save OFF"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:567,columnNumber:15},void 0),o.jsxDEV("button",{onClick:X,disabled:D,className:`
                  flex items-center justify-center w-8 h-8 rounded-full transition-colors
                  ${D?"text-gray-400 cursor-not-allowed":"text-green-600 hover:bg-green-100"}
                `,"aria-label":"Force save state",title:"Force save current state",children:D?o.jsxDEV("span",{className:"animate-spin",children:"â€¢"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:593,columnNumber:19},void 0):o.jsxDEV(te,{className:"w-5 h-5"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:595,columnNumber:19},void 0)},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:580,columnNumber:15},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:566,columnNumber:13},void 0),o.jsxDEV("button",{onClick:()=>r.dispatch(ne()),className:"text-foreground hover:text-foreground/80","aria-label":"Toggle theme",children:d==="light"?o.jsxDEV(oe,{className:"w-6 h-6"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:605,columnNumber:17},void 0):o.jsxDEV(se,{className:"w-6 h-6"},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:607,columnNumber:17},void 0)},void 0,!1,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:599,columnNumber:13},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:565,columnNumber:11},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:530,columnNumber:7},void 0)]},void 0,!0,{fileName:"/Users/Henrykoo/Documents/redux_todo_in_astro/src/components/panels/TopBar.tsx",lineNumber:521,columnNumber:5},void 0)};export{fe as TopBar,fe as default};
