FROM node:20-bullseye

WORKDIR /app

# Install build dependencies
COPY package*.json ./
RUN npm install && \
    npm install marked pdfjs-dist@5.1.91 serve

# Create temp directory for PDF files
RUN mkdir -p /tmp/pdf-files/

# First copy the PDF files - use a different approach without wildcards
COPY public/data/ /tmp/pdf-files/

# Copy the rest of the application
COPY . .

# Create directory for PDF.js worker
RUN mkdir -p public/assets

# Copy PDF.js worker files to public/assets for proper loading
RUN cp -r node_modules/pdfjs-dist/build/pdf.worker.* public/assets/

# Create directory structure for PDF access
RUN mkdir -p public/data
RUN mkdir -p /data

# Copy the PDF files to their intended locations
RUN cp -f /tmp/pdf-files/*.pdf public/ || echo "No PDF files found in /tmp"
RUN cp -f /tmp/pdf-files/*.pdf public/data/ || echo "No PDF files found in /tmp"

# Create symbolic links
RUN ln -sf /app/public/data/* /data/ || echo "No data files to link"

# Verify PDF files exist
RUN ls -la /app/public/*.pdf || echo "No PDF files in public root"
RUN ls -la /app/public/data/*.pdf || echo "No PDF files in public/data"

EXPOSE 4321

# Environment variables for Vite dev server
ENV HOST=0.0.0.0
ENV PORT=4321
ENV VITE_TIMEOUT=0

# Use host binding to make server accessible with increased timeout
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--timeout", "0"]
