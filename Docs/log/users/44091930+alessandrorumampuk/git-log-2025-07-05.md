# Git Activity Log - 44091930+alessandrorumampuk
Generated at: Sat Jul  5 00:45:17 UTC 2025
## Changes by 44091930+alessandrorumampuk
```diff
commit 74178f67660f0900b8c1c3675aa948d9e2d5b069
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:50:52 2025 +0800

    Delete src/pages/auth/notion/success.astro

diff --git a/src/pages/auth/notion/success.astro b/src/pages/auth/notion/success.astro
deleted file mode 100644
index 1168a1b..0000000
--- a/src/pages/auth/notion/success.astro
+++ /dev/null
@@ -1,126 +0,0 @@
----
-import SimpleLayout from '../../../layouts/SimpleLayout.astro';
-
-// Get session data
-let workspaceName = '';
-const sessionData = Astro.cookies.get('notion_session')?.json();
-if (sessionData?.workspace_name) {
-  workspaceName = sessionData.workspace_name;
-} else {
-  return Astro.redirect('/page');
-}
----
-
-<SimpleLayout title="Notion Connection Successful">
-  <div class="success-container">
-    <div class="success-card">
-      <div class="success-icon">✓</div>
-      <h1>Successfully Connected to Notion!</h1>
-      <p>Connected to workspace: <strong>{workspaceName}</strong></p>
-      <div class="redirect-message">
-        <p>Connecting to Notion...</p>
-      </div>
-      <div class="success-actions">
-        <button onclick="window.close()" class="close-button">Close Window</button>
-      </div>
-    </div>
-  </div>
-</SimpleLayout>
-
-<style>
-  .success-container {
-    display: flex;
-    justify-content: center;
-    align-items: center;
-    min-height: 60vh;
-    padding: 20px;
-  }
-
-  .success-card {
-    background: white;
-    padding: 40px;
-    border-radius: 12px;
-    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
-    text-align: center;
-    max-width: 500px;
-    width: 100%;
-  }
-
-  .success-icon {
-    width: 60px;
-    height: 60px;
-    background: #2ecc71;
-    color: white;
-    border-radius: 50%;
-    display: flex;
-    align-items: center;
-    justify-content: center;
-    font-size: 32px;
-    margin: 0 auto 20px;
-  }
-
-  h1 {
-    color: #2c3e50;
-    font-size: 24px;
-    margin-bottom: 16px;
-  }
-
-  p {
-    color: #34495e;
-    margin-bottom: 12px;
-  }
-
-  .redirect-message {
-    margin-top: 24px;
-    padding-top: 16px;
-    border-top: 1px solid #eee;
-  }
-
-  .redirect-message p {
-    color: #7f8c8d;
-    font-size: 14px;
-  }
-
-  .success-actions {
-    margin-top: 20px;
-  }
-
-  .close-button {
-    background: #2ecc71;
-    color: white;
-    border: none;
-    padding: 10px 20px;
-    border-radius: 6px;
-    cursor: pointer;
-    font-size: 14px;
-    transition: background 0.2s;
-  }
-
-  .close-button:hover {
-    background: #27ae60;
-  }
-</style>
-
-<script>
-  // The tokens are already stored in localStorage by the callback page
-
-  // Update the UI to show success
-  const messageEl = document.querySelector('.redirect-message p');
-  if (messageEl) {
-    messageEl.textContent = 'Successfully connected! Redirecting to dashboard...';
-  }
-
-  // Dispatch a custom event to notify the NotionPanel component
-  window.dispatchEvent(new CustomEvent('notionConnected', {
-    detail: {
-      accessToken,
-      workspaceId,
-      workspaceName
-    }
-  }));
-
-  // Redirect to /page after a short delay
-  setTimeout(() => {
-    window.location.href = '/page';
-  }, 2000);
-</script>

commit f1b213104dff2315eca0c5d57936a599bba42057
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:50:26 2025 +0800

    Update callback.astro

diff --git a/src/pages/auth/notion/callback.astro b/src/pages/auth/notion/callback.astro
index 7d434ab..441edb8 100644
--- a/src/pages/auth/notion/callback.astro
+++ b/src/pages/auth/notion/callback.astro
@@ -107,8 +107,8 @@ if (code) {
             // Notify components about successful connection
             window.dispatchEvent(new CustomEvent('notionConnected', { detail: authData }));
 
-            // Redirect to success page without sensitive data in URL
-            window.location.href = '/auth/notion/success';
+            // Redirect directly to page
+            window.location.href = '/Page';
           </script>
           <div style="text-align: center; padding: 20px;">
             <p>Completing authentication...</p>

commit 257f44afa1a8bbb06c3577aff38d4860fde8eeb6
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:43:17 2025 +0800

    Update callback.astro

diff --git a/src/pages/auth/notion/callback.astro b/src/pages/auth/notion/callback.astro
index 8d0571e..7d434ab 100644
--- a/src/pages/auth/notion/callback.astro
+++ b/src/pages/auth/notion/callback.astro
@@ -70,8 +70,54 @@ if (code) {
       throw new Error('No access token received');
     }
 
-    // Redirect to the success page with token data
-    return Astro.redirect(`/auth/notion/success?access_token=${data.access_token}&workspace_id=${data.workspace_id}&workspace_name=${encodeURIComponent(data.workspace_name)}`);
+    // Store tokens securely in session
+    if (!Astro.cookies.has('notion_session')) {
+      Astro.cookies.set('notion_session', JSON.stringify({
+        access_token: data.access_token,
+        workspace_id: data.workspace_id,
+        workspace_name: data.workspace_name
+      }), {
+        httpOnly: true,
+        secure: true,
+        sameSite: 'strict',
+        path: '/'
+      });
+    }
+
+    // Return a page that will store tokens in localStorage and redirect
+    return new Response(`
+      <!DOCTYPE html>
+      <html>
+        <head>
+          <title>Completing Authentication...</title>
+        </head>
+        <body>
+          <script>
+            // Store the tokens in localStorage
+            const authData = ${JSON.stringify({
+              access_token: data.access_token,
+              workspace_id: data.workspace_id,
+              workspace_name: data.workspace_name
+            })};
+            
+            localStorage.setItem('notion_access_token', authData.access_token);
+            localStorage.setItem('notion_workspace_id', authData.workspace_id);
+            localStorage.setItem('notion_workspace_name', authData.workspace_name);
+
+            // Notify components about successful connection
+            window.dispatchEvent(new CustomEvent('notionConnected', { detail: authData }));
+
+            // Redirect to success page without sensitive data in URL
+            window.location.href = '/auth/notion/success';
+          </script>
+          <div style="text-align: center; padding: 20px;">
+            <p>Completing authentication...</p>
+          </div>
+        </body>
+      </html>
+    `, {
+      headers: { 'Content-Type': 'text/html' }
+    });
   } catch (err) {
     console.error('OAuth error:', err);
     error = err.message;

commit 030b9788bf897e4e3cb012d96840464b76e44e0e
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:43:01 2025 +0800

    Update success.astro

diff --git a/src/pages/auth/notion/success.astro b/src/pages/auth/notion/success.astro
index 9c6db6c..1168a1b 100644
--- a/src/pages/auth/notion/success.astro
+++ b/src/pages/auth/notion/success.astro
@@ -1,11 +1,12 @@
 ---
 import SimpleLayout from '../../../layouts/SimpleLayout.astro';
 
-const accessToken = Astro.url.searchParams.get('access_token');
-const workspaceId = Astro.url.searchParams.get('workspace_id');
-const workspaceName = Astro.url.searchParams.get('workspace_name');
-
-if (!accessToken) {
+// Get session data
+let workspaceName = '';
+const sessionData = Astro.cookies.get('notion_session')?.json();
+if (sessionData?.workspace_name) {
+  workspaceName = sessionData.workspace_name;
+} else {
   return Astro.redirect('/page');
 }
 ---
@@ -101,21 +102,12 @@ if (!accessToken) {
 </style>
 
 <script>
-  // Store the tokens in localStorage immediately
-  const params = new URLSearchParams(window.location.search);
-  const accessToken = params.get('access_token');
-  const workspaceId = params.get('workspace_id');
-  const workspaceName = params.get('workspace_name');
-  
-  // Store the tokens in localStorage
-  localStorage.setItem('notion_access_token', accessToken);
-  localStorage.setItem('notion_workspace_id', workspaceId);
-  localStorage.setItem('notion_workspace_name', workspaceName);
+  // The tokens are already stored in localStorage by the callback page
 
   // Update the UI to show success
   const messageEl = document.querySelector('.redirect-message p');
   if (messageEl) {
-    messageEl.textContent = 'Successfully connected! You can now use Notion features.';
+    messageEl.textContent = 'Successfully connected! Redirecting to dashboard...';
   }
 
   // Dispatch a custom event to notify the NotionPanel component
@@ -126,4 +118,9 @@ if (!accessToken) {
       workspaceName
     }
   }));
+
+  // Redirect to /page after a short delay
+  setTimeout(() => {
+    window.location.href = '/page';
+  }, 2000);
 </script>

commit 261d36e1310a3a5356b3c5ed963636c8ff708277
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:29:55 2025 +0800

    Update notion.jsx

diff --git a/src/components/panels/notion.jsx b/src/components/panels/notion.jsx
index 401834e..d2b9c87 100644
--- a/src/components/panels/notion.jsx
+++ b/src/components/panels/notion.jsx
@@ -1,5 +1,8 @@
 import React, { useState, useEffect } from 'react';
 
+// Notion OAuth configuration
+const NOTION_AUTH_URL = 'https://api.notion.com/v1/oauth/authorize?client_id=226d872b-594c-80ac-90cf-003720fc68f2&response_type=code&owner=user&redirect_uri=http%3A%2F%2Flocalhost%3A4321%2Fauth%2Fnotion%2Fcallback';
+
 // Add the extractTitle helper function
 const extractTitle = (page) => {
   if (page.properties && page.properties.title) {
@@ -16,14 +19,67 @@ const NotionPanel = ({ className = '' }) => {
   const [loading, setLoading] = useState(false);
   const [error, setError] = useState(null);
   const [pageId, setPageId] = useState(''); // Default page ID
-  const [connected, setConnected] = useState(true); // Default to true since we don't have actual WebSocket connection
+  const [connected, setConnected] = useState(false); // Default to false until authenticated
+  const [accessToken, setAccessToken] = useState(null);
+  const [workspaceName, setWorkspaceName] = useState('');
+
+  // Check for existing token and listen for OAuth success
+  useEffect(() => {
+    const savedToken = localStorage.getItem('notion_access_token');
+    if (savedToken) {
+      const savedWorkspaceName = localStorage.getItem('notion_workspace_name');
+      setAccessToken(savedToken);
+      setWorkspaceName(savedWorkspaceName || '');
+      setConnected(true);
+      console.log('Restored previous Notion session');
+    }
+
+    // Listen for OAuth success event
+    const handleNotionConnected = (event) => {
+      const { accessToken, workspaceId, workspaceName } = event.detail;
+      setAccessToken(accessToken);
+      setWorkspaceName(workspaceName);
+      setConnected(true);
+      console.log('Notion connected via OAuth');
+    };
+
+    window.addEventListener('notionConnected', handleNotionConnected);
+    return () => window.removeEventListener('notionConnected', handleNotionConnected);
+  }, []);
 
-  // Auto-sync when pageId changes
+  // Auto-sync when pageId changes and we're connected
   useEffect(() => {
-    if (pageId) {
+    if (pageId && connected) {
       syncPage(pageId);
     }
-  }, [pageId]);
+  }, [pageId, connected]);
+
+
+
+  const handleLogin = () => {
+    // Open OAuth window
+    const width = 600;
+    const height = 700;
+    const left = window.screen.width / 2 - width / 2;
+    const top = window.screen.height / 2 - height / 2;
+    
+    window.open(
+      NOTION_AUTH_URL,
+      'Notion OAuth',
+      `width=${width},height=${height},left=${left},top=${top}`
+    );
+  };
+
+  const handleLogout = () => {
+    localStorage.removeItem('notion_access_token');
+    localStorage.removeItem('notion_workspace_id');
+    localStorage.removeItem('notion_workspace_name');
+    
+    setAccessToken(null);
+    setConnected(false);
+    setDocuments([]);
+    setError(null);
+  };
 
 
 
@@ -142,20 +198,11 @@ const NotionPanel = ({ className = '' }) => {
         });
       }
 
-      // Get fresh data from Notion
-      const response = await fetch(`/api/notion/page?pageId=${pageId}`);
+      // Get fresh data from Notion through our API endpoint
+      const response = await fetch(`/api/notion/getpage?pageId=${pageId}&accessToken=${accessToken}`);
       const data = await response.json();
       
       if (data.success) {
-        // Update cache
-        const cache = await caches.open('notion-cache-v2');
-        await cache.put(
-          `notion-page-${pageId}`,
-          new Response(JSON.stringify(data), {
-            headers: { 'Content-Type': 'application/json' }
-          })
-        );
-
         const formattedDoc = {
           id: data.document.page.id,
           title: extractTitle(data.document.page),
@@ -171,12 +218,12 @@ const NotionPanel = ({ className = '' }) => {
         });
         
         await uploadToCardCollection([formattedDoc]);
+      } else if (data.error) {
+        throw new Error(data.error);
       }
     } catch (err) {
       console.error('Sync error:', err);
-      if (!documents.length) {
-        setError('Failed to fetch data. Please check your connection.');
-      }
+      setError(err.message || 'Failed to fetch data. Please check your connection.');
     } finally {
       setLoading(false);
     }
@@ -211,7 +258,28 @@ const NotionPanel = ({ className = '' }) => {
     <div className={`notion-panel ${className}`} style={{ padding: '20px', backgroundColor: 'white', height: '100%', overflowY: 'auto' }}>
       
       <div className="controls">
-        <div className="input-group">
+        {!connected ? (
+          <button
+            onClick={handleLogin}
+            className="connect-button"
+            style={{
+              padding: '10px 20px',
+              backgroundColor: '#000',
+              color: '#fff',
+              border: 'none',
+              borderRadius: '4px',
+              cursor: 'pointer',
+              fontSize: '14px',
+              fontWeight: '500',
+              display: 'flex',
+              alignItems: 'center',
+              gap: '8px'
+            }}
+          >
+            Connect to Notion
+          </button>
+        ) : (
+          <div className="input-group">
           <div style={{ position: 'relative', flex: 1 }}>
             <input 
               value={pageId}
@@ -259,9 +327,54 @@ const NotionPanel = ({ className = '' }) => {
           >
             {loading ? 'Syncing...' : 'Sync Page'}
           </button>
-        </div>
+          </div>
+        )}
       </div>
 
+      {/* Workspace Info & Logout */}
+      {connected && (
+        <div className="workspace-info" style={{
+          display: 'flex',
+          justifyContent: 'space-between',
+          alignItems: 'center',
+          padding: '10px 0',
+          marginBottom: '20px',
+          borderBottom: '1px solid #e0e0e0'
+        }}>
+          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
+            <span style={{ 
+              backgroundColor: '#000',
+              color: '#fff',
+              width: '24px',
+              height: '24px',
+              borderRadius: '4px',
+              display: 'flex',
+              alignItems: 'center',
+              justifyContent: 'center',
+              fontSize: '12px'
+            }}>
+              {workspaceName.charAt(0)}
+            </span>
+            <span style={{ fontWeight: '500' }}>{workspaceName}</span>
+          </div>
+          <button
+            onClick={handleLogout}
+            style={{
+              padding: '6px 12px',
+              backgroundColor: '#f5f5f5',
+              border: 'none',
+              borderRadius: '4px',
+              cursor: 'pointer',
+              fontSize: '14px',
+              color: '#666',
+              transition: 'all 0.2s'
+            }}
+          >
+            Logout
+          </button>
+        </div>
+      )}
+
       {error && (
         <div className="error-message">
           ⚠️ {error}

commit 2bfc41aa5231a8b85ae89987c5932da56ecd0fb9
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:28:00 2025 +0800

    Create callback.js

diff --git a/src/pages/api/notion/callback.js b/src/pages/api/notion/callback.js
new file mode 100644
index 0000000..b33f317
--- /dev/null
+++ b/src/pages/api/notion/callback.js
@@ -0,0 +1,72 @@
+export async function post({ request }) {
+  try {
+    const body = await request.json();
+    const { code } = body;
+
+    if (!code) {
+      return new Response(JSON.stringify({
+        error: 'No authorization code provided'
+      }), {
+        status: 400,
+        headers: {
+          'Content-Type': 'application/json'
+        }
+      });
+    }
+
+    const clientId = import.meta.env.NOTION_CLIENT_ID;
+    const clientSecret = import.meta.env.NOTION_CLIENT_SECRET;
+
+    if (!clientId || !clientSecret) {
+      return new Response(JSON.stringify({
+        error: 'Missing Notion credentials in environment variables'
+      }), {
+        status: 500,
+        headers: {
+          'Content-Type': 'application/json'
+        }
+      });
+    }
+
+    const tokenResponse = await fetch('https://api.notion.com/v1/oauth/token', {
+      method: 'POST',
+      headers: {
+        'Authorization': `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString('base64')}`,
+        'Content-Type': 'application/json',
+        'Notion-Version': '2022-06-28'
+      },
+      body: JSON.stringify({
+        grant_type: 'authorization_code',
+        code,
+        redirect_uri: 'http://localhost:4321/auth/notion/callback'
+      })
+    });
+
+    if (!tokenResponse.ok) {
+      const error = await tokenResponse.text();
+      throw new Error(`Notion API error: ${error}`);
+    }
+
+    const tokenData = await tokenResponse.json();
+
+    return new Response(JSON.stringify({
+      success: true,
+      ...tokenData
+    }), {
+      status: 200,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  } catch (error) {
+    console.error('Notion callback error:', error);
+    return new Response(JSON.stringify({
+      error: error.message || 'Internal server error'
+    }), {
+      status: 500,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  }
+}

commit ad3a345b7aeb3d8f3f63f976ed0905a480b2abdd
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:27:35 2025 +0800

    Create getpage.astro

diff --git a/src/pages/api/notion/getpage.astro b/src/pages/api/notion/getpage.astro
new file mode 100644
index 0000000..da8622a
--- /dev/null
+++ b/src/pages/api/notion/getpage.astro
@@ -0,0 +1,108 @@
+---
+if (Astro.request.method !== 'GET') {
+  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
+    status: 405,
+    headers: {
+      'Content-Type': 'application/json'
+    }
+  });
+}
+
+const url = new URL(Astro.request.url);
+const pageId = url.searchParams.get('pageId');
+const accessToken = url.searchParams.get('accessToken');
+
+if (!pageId || !accessToken) {
+  return new Response(JSON.stringify({
+    error: 'Missing pageId or accessToken'
+  }), {
+    status: 400,
+    headers: {
+      'Content-Type': 'application/json'
+    }
+  });
+}
+
+try {
+  const response = await fetch(`https://api.notion.com/v1/pages/${pageId}`, {
+    headers: {
+      'Authorization': `Bearer ${accessToken}`,
+      'Notion-Version': '2022-06-28'
+    }
+  });
+
+  if (!response.ok) {
+    const errorText = await response.text();
+    console.error('Notion API error:', errorText);
+    throw new Error(`Notion API error: ${response.statusText}`);
+  }
+
+  const pageData = await response.json();
+
+  // Get block children for content
+  const blocksResponse = await fetch(`https://api.notion.com/v1/blocks/${pageId}/children`, {
+    headers: {
+      'Authorization': `Bearer ${accessToken}`,
+      'Notion-Version': '2022-06-28'
+    }
+  });
+
+  const blocksData = await blocksResponse.json();
+
+  // Process blocks into our format
+  const tables = [];
+  const descriptions = [];
+  const subheadings = [];
+
+  if (blocksData.results) {
+    blocksData.results.forEach(block => {
+      switch (block.type) {
+        case 'paragraph':
+          if (block.paragraph.rich_text.length > 0) {
+            descriptions.push({
+              id: block.id,
+              content: block.paragraph.rich_text.map(text => text.plain_text).join('')
+            });
+          }
+          break;
+        case 'heading_1':
+        case 'heading_2':
+        case 'heading_3':
+          if (block[block.type].rich_text.length > 0) {
+            subheadings.push({
+              id: block.id,
+              level: parseInt(block.type.slice(-1)),
+              content: block[block.type].rich_text.map(text => text.plain_text).join('')
+            });
+          }
+          break;
+      }
+    });
+  }
+
+  return new Response(JSON.stringify({
+    success: true,
+    document: {
+      page: pageData,
+      tables,
+      descriptions,
+      subheadings
+    }
+  }), {
+    status: 200,
+    headers: {
+      'Content-Type': 'application/json'
+    }
+  });
+} catch (error) {
+  console.error('Error:', error);
+  return new Response(JSON.stringify({
+    error: error.message
+  }), {
+    status: 500,
+    headers: {
+      'Content-Type': 'application/json'
+    }
+  });
+}
+---

commit 41db61135eba2c7821669deeffbb0480a1850722
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:27:11 2025 +0800

    Create getpage.js

diff --git a/src/pages/api/notion/getpage.js b/src/pages/api/notion/getpage.js
new file mode 100644
index 0000000..0db69f2
--- /dev/null
+++ b/src/pages/api/notion/getpage.js
@@ -0,0 +1,51 @@
+export const get = async ({ request }) => {
+  const url = new URL(request.url);
+  const pageId = url.searchParams.get('pageId');
+  const accessToken = url.searchParams.get('accessToken');
+
+  if (!pageId || !accessToken) {
+    return new Response(JSON.stringify({
+      error: 'Missing pageId or accessToken'
+    }), {
+      status: 400,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  }
+
+  try {
+    const response = await fetch(`https://api.notion.com/v1/pages/${pageId}`, {
+      headers: {
+        'Authorization': `Bearer ${accessToken}`,
+        'Notion-Version': '2022-06-28'
+      }
+    });
+
+    const data = await response.json();
+
+    return new Response(JSON.stringify({
+      success: true,
+      document: {
+        page: data,
+        tables: [],  // You can add logic to extract tables if needed
+        descriptions: [],  // You can add logic to extract descriptions if needed
+        subheadings: []  // You can add logic to extract subheadings if needed
+      }
+    }), {
+      status: 200,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  } catch (error) {
+    return new Response(JSON.stringify({
+      error: error.message
+    }), {
+      status: 500,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  }
+}

commit ca68b83ca086a6a2a6c1297dd1ced3b3fa993ec4
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:26:46 2025 +0800

    Create index.js

diff --git a/src/pages/api/notion/getpage/index.js b/src/pages/api/notion/getpage/index.js
new file mode 100644
index 0000000..6d11574
--- /dev/null
+++ b/src/pages/api/notion/getpage/index.js
@@ -0,0 +1,111 @@
+export const get = async ({ request }) => {
+  try {
+    const url = new URL(request.url);
+    const pageId = url.searchParams.get('pageId');
+    const accessToken = url.searchParams.get('accessToken');
+
+    if (!pageId || !accessToken) {
+      return new Response(JSON.stringify({
+        error: 'Missing pageId or accessToken'
+      }), {
+        status: 400,
+        headers: {
+          'Content-Type': 'application/json'
+        }
+      });
+    }
+
+    // Fetch page data
+    const pageResponse = await fetch(`https://api.notion.com/v1/pages/${pageId}`, {
+      headers: {
+        'Authorization': `Bearer ${accessToken}`,
+        'Notion-Version': '2022-06-28'
+      }
+    });
+
+    if (!pageResponse.ok) {
+      const errorText = await pageResponse.text();
+      console.error('Notion API error:', errorText);
+      throw new Error(`Notion API error: ${pageResponse.statusText}`);
+    }
+
+    const pageData = await pageResponse.json();
+
+    // Fetch block children
+    const blocksResponse = await fetch(`https://api.notion.com/v1/blocks/${pageId}/children`, {
+      headers: {
+        'Authorization': `Bearer ${accessToken}`,
+        'Notion-Version': '2022-06-28'
+      }
+    });
+
+    if (!blocksResponse.ok) {
+      throw new Error(`Failed to fetch blocks: ${blocksResponse.statusText}`);
+    }
+
+    const blocksData = await blocksResponse.json();
+
+    // Process blocks
+    const tables = [];
+    const descriptions = [];
+    const subheadings = [];
+
+    if (blocksData.results) {
+      blocksData.results.forEach(block => {
+        switch (block.type) {
+          case 'paragraph':
+            if (block.paragraph.rich_text.length > 0) {
+              descriptions.push({
+                id: block.id,
+                content: block.paragraph.rich_text.map(text => text.plain_text).join('')
+              });
+            }
+            break;
+          case 'heading_1':
+          case 'heading_2':
+          case 'heading_3':
+            if (block[block.type].rich_text.length > 0) {
+              subheadings.push({
+                id: block.id,
+                level: parseInt(block.type.slice(-1)),
+                content: block[block.type].rich_text.map(text => text.plain_text).join('')
+              });
+            }
+            break;
+          case 'table':
+            tables.push({
+              id: block.id,
+              rows: block.table.rows || []
+            });
+            break;
+        }
+      });
+    }
+
+    return new Response(JSON.stringify({
+      success: true,
+      document: {
+        page: pageData,
+        tables,
+        descriptions,
+        subheadings
+      }
+    }), {
+      status: 200,
+      headers: {
+        'Content-Type': 'application/json',
+        'Cache-Control': 'no-cache'
+      }
+    });
+  } catch (error) {
+    console.error('Error in getpage:', error);
+    return new Response(JSON.stringify({
+      error: error.message || 'Internal server error'
+    }), {
+      status: 500,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  }
+};

commit a5ada017d0ab1ae1a7d43965f9c77d39952eabfe
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:26:05 2025 +0800

    Create success.astro

diff --git a/src/pages/auth/notion/success.astro b/src/pages/auth/notion/success.astro
new file mode 100644
index 0000000..9c6db6c
--- /dev/null
+++ b/src/pages/auth/notion/success.astro
@@ -0,0 +1,129 @@
+---
+import SimpleLayout from '../../../layouts/SimpleLayout.astro';
+
+const accessToken = Astro.url.searchParams.get('access_token');
+const workspaceId = Astro.url.searchParams.get('workspace_id');
+const workspaceName = Astro.url.searchParams.get('workspace_name');
+
+if (!accessToken) {
+  return Astro.redirect('/page');
+}
+---
+
+<SimpleLayout title="Notion Connection Successful">
+  <div class="success-container">
+    <div class="success-card">
+      <div class="success-icon">✓</div>
+      <h1>Successfully Connected to Notion!</h1>
+      <p>Connected to workspace: <strong>{workspaceName}</strong></p>
+      <div class="redirect-message">
+        <p>Connecting to Notion...</p>
+      </div>
+      <div class="success-actions">
+        <button onclick="window.close()" class="close-button">Close Window</button>
+      </div>
+    </div>
+  </div>
+</SimpleLayout>
+
+<style>
+  .success-container {
+    display: flex;
+    justify-content: center;
+    align-items: center;
+    min-height: 60vh;
+    padding: 20px;
+  }
+
+  .success-card {
+    background: white;
+    padding: 40px;
+    border-radius: 12px;
+    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
+    text-align: center;
+    max-width: 500px;
+    width: 100%;
+  }
+
+  .success-icon {
+    width: 60px;
+    height: 60px;
+    background: #2ecc71;
+    color: white;
+    border-radius: 50%;
+    display: flex;
+    align-items: center;
+    justify-content: center;
+    font-size: 32px;
+    margin: 0 auto 20px;
+  }
+
+  h1 {
+    color: #2c3e50;
+    font-size: 24px;
+    margin-bottom: 16px;
+  }
+
+  p {
+    color: #34495e;
+    margin-bottom: 12px;
+  }
+
+  .redirect-message {
+    margin-top: 24px;
+    padding-top: 16px;
+    border-top: 1px solid #eee;
+  }
+
+  .redirect-message p {
+    color: #7f8c8d;
+    font-size: 14px;
+  }
+
+  .success-actions {
+    margin-top: 20px;
+  }
+
+  .close-button {
+    background: #2ecc71;
+    color: white;
+    border: none;
+    padding: 10px 20px;
+    border-radius: 6px;
+    cursor: pointer;
+    font-size: 14px;
+    transition: background 0.2s;
+  }
+
+  .close-button:hover {
+    background: #27ae60;
+  }
+</style>
+
+<script>
+  // Store the tokens in localStorage immediately
+  const params = new URLSearchParams(window.location.search);
+  const accessToken = params.get('access_token');
+  const workspaceId = params.get('workspace_id');
+  const workspaceName = params.get('workspace_name');
+  
+  // Store the tokens in localStorage
+  localStorage.setItem('notion_access_token', accessToken);
+  localStorage.setItem('notion_workspace_id', workspaceId);
+  localStorage.setItem('notion_workspace_name', workspaceName);
+
+  // Update the UI to show success
+  const messageEl = document.querySelector('.redirect-message p');
+  if (messageEl) {
+    messageEl.textContent = 'Successfully connected! You can now use Notion features.';
+  }
+
+  // Dispatch a custom event to notify the NotionPanel component
+  window.dispatchEvent(new CustomEvent('notionConnected', {
+    detail: {
+      accessToken,
+      workspaceId,
+      workspaceName
+    }
+  }));
+</script>

commit d8ba6383d459c0d78add7c6a899232d9191c0751
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:25:40 2025 +0800

    Update callback.astro

diff --git a/src/pages/auth/notion/callback.astro b/src/pages/auth/notion/callback.astro
index 091dfb7..8d0571e 100644
--- a/src/pages/auth/notion/callback.astro
+++ b/src/pages/auth/notion/callback.astro
@@ -1,229 +1,98 @@
 ---
-import Layout from '../layouts/BaseLayout.astro';
-
-// Remove the immediate server-side redirect to allow client-side code to run first
----
-
-<Layout title="Authentication Callback">
-  <!-- Immediate inline script for debugging -->
-  <script is:inline>
-    console.log('INLINE DEBUG: Script executing', {
-      time: new Date().toISOString(),
-      url: window.location.href,
-      code: new URLSearchParams(window.location.search).get('code') ? 'present' : 'missing'
+const code = Astro.url.searchParams.get('code');
+const state = Astro.url.searchParams.get('state');
+
+let error = '';
+
+if (code) {
+  try {
+    // Get credentials from environment variables
+    const clientId = import.meta.env.PUBLIC_NOTION_CLIENT_ID;
+    const clientSecret = import.meta.env.PUBLIC_NOTION_CLIENT_SECRET;
+
+    // Debug: Log environment variable presence (not values)
+    console.log('Environment variables check:', {
+      hasClientId: !!clientId,
+      hasClientSecret: !!clientSecret,
+      envKeys: Object.keys(import.meta.env)
     });
 
-    // Store the redirect path in localStorage as early as possible
-    try {
-      localStorage.setItem('authentik_top_banner_authredirect_uri', '/Page');
-      console.log('INLINE DEBUG: Stored redirect path in localStorage');
-    } catch (storageError) {
-      console.error('INLINE DEBUG: Error storing redirect path:', storageError);
+    if (!clientId || !clientSecret) {
+      throw new Error('Missing Notion credentials. Please check your .env file');
     }
-  </script>
-  
-  <div class="min-h-screen flex items-center justify-center">
-    <div class="text-center">
-      <h1 class="text-2xl font-semibold mb-4">Processing Authentication...</h1>
-      <p class="text-gray-600">You will be redirected back automatically.</p>
-    </div>
-  </div>
 
-  <script>
-    // Immediate logging to verify script execution
-    console.log('CALLBACK DEBUG: Script started', {
-      timestamp: new Date().toISOString(),
-      url: window.location.href
+    // Create authorization string with proper encoding
+    const credentials = `${clientId}:${clientSecret}`;
+    const authString = Buffer.from(credentials).toString('base64');
+    
+    console.log('Starting OAuth token exchange...');
+    console.log('Authorization code length:', code?.length);
+    console.log('Using redirect URI:', 'http://localhost:4321/auth/notion/callback');
+
+    const response = await fetch('https://api.notion.com/v1/oauth/token', {
+      method: 'POST',
+      headers: {
+        'Authorization': `Basic ${authString}`,
+        'Content-Type': 'application/json',
+        'Accept': 'application/json',
+        'Notion-Version': '2022-06-28'
+      },
+      body: JSON.stringify({
+        grant_type: 'authorization_code',
+        code: code,
+        redirect_uri: 'http://localhost:4321/auth/notion/callback'
+      })
     });
 
-    // Function to handle the authentication callback
-    async function handleAuthCallback() {
-      console.log('CALLBACK DEBUG: handleAuthCallback function called');
-      
+    if (!response.ok) {
+      const errorText = await response.text();
+      let errorJson;
       try {
-        // Extract the authorization code from the URL and trim any whitespace
-        const urlParams = new URLSearchParams(window.location.search);
-        const rawCode = urlParams.get('code');
-        const rawState = urlParams.get('state');
-        const code = rawCode ? rawCode.trim() : null;
-
-        // Detailed logging of all URL parameters
-        console.log('Authentication Callback Full URL Details:', {
-          fullUrl: window.location.href,
-          searchParams: Object.fromEntries(urlParams.entries())
-        });
-
-        if (!code) {
-          console.error('No authorization code found');
-          throw new Error('No authorization code present in the URL');
-        }
-
-        // Log detailed debug information
-        console.log('Authentication Callback Debug:', {
-          code: code ? 'Code Present' : 'No Code',
-          rawCode,
-          rawState,
-          origin: window.location.origin,
-          fullUrl: window.location.href,
-          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID ? 'Present' : 'Missing',
-          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
-          redirectUri: import.meta.env.PUBLIC_AUTHENTIK_REDIRECT_URI,
-          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET ? 'Present' : 'Missing'
-        });
-
-        // Import the Authentik client dynamically
-        console.log('CALLBACK DEBUG: About to import authentik client');
-        let createClient;
-        try {
-          const module = await import('../lib/authentik/client');
-          createClient = module.createClient;
-          console.log('CALLBACK DEBUG: Authentik client imported successfully');
-        } catch (importError: unknown) {
-          console.error('CALLBACK DEBUG: Failed to import authentik client', 
-            importError instanceof Error ? 
-              { message: importError.message, stack: importError.stack } : 
-              String(importError)
-          );
-          throw new Error(`Import failed: ${importError instanceof Error ? importError.message : String(importError)}`);
-        }
-
-        if (!createClient || typeof createClient !== 'function') {
-          console.error('CALLBACK DEBUG: createClient is not a function', { createClient });
-          throw new Error('createClient is not a function');
-        }
-
-        // Hardcode the redirect URI based on hostname for maximum reliability
-        const isLocalhost = window.location.hostname === 'localhost';
-        const hardcodedRedirectUri = isLocalhost ? 'http://localhost:4321/callback' : 'http://todo.pkc.pub/callback';
-
-        console.log('Callback page redirect URI check:', {
-          isLocalhost,
-          hardcodedRedirectUri,
-          currentUrl: window.location.href
-        });
-
-        // Create the Authentik client with the same configuration used in TopBar
-        const client = createClient({
-          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
-          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET || '',
-          redirectUri: hardcodedRedirectUri,
-          scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
-          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
-          storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
-        });
+        errorJson = JSON.parse(errorText);
+      } catch (e) {
+        errorJson = null;
+      }
 
-        // Handle the callback
-        console.log('CALLBACK DEBUG: About to call client.handleCallback');
-        const userInfo = await client.handleCallback(code);
-        
-        console.log('Authentication Successful:', {
-          userInfoReceived: !!userInfo,
-          userInfoFields: userInfo ? Object.keys(userInfo) : [],
-          accessTokenReceived: !!userInfo?.access_token
-        });
-        
-        // Explicitly store all user information in localStorage with multiple keys for redundancy
-        if (userInfo && typeof userInfo === 'object') {
-          try {
-            // Get the storage key prefix
-            const authStorageKeyPrefix = import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_';
-            
-            // Store user info in multiple formats to ensure it's found
-            localStorage.setItem(`${authStorageKeyPrefix}top_banner_authuser_info`, JSON.stringify(userInfo));
-            localStorage.setItem(`${authStorageKeyPrefix}user_info`, JSON.stringify(userInfo));
-            
-            // Store tokens separately for easier access
-            if (userInfo.access_token) {
-              localStorage.setItem(`${authStorageKeyPrefix}top_banner_authaccess_token`, userInfo.access_token);
-              localStorage.setItem(`${authStorageKeyPrefix}access_token`, userInfo.access_token);
-            }
-            
-            if (userInfo.id_token) {
-              localStorage.setItem(`${authStorageKeyPrefix}top_banner_authid_token`, userInfo.id_token);
-              localStorage.setItem(`${authStorageKeyPrefix}id_token`, userInfo.id_token);
-            }
-            
-            // Log successful storage
-            console.log('Authentication data stored successfully', {
-              keys: Object.keys(localStorage).filter(k => k.includes(authStorageKeyPrefix)),
-              userInfoSize: JSON.stringify(userInfo).length
-            });
-            
-            // Dispatch login action to Redux if possible
-            if (typeof window !== 'undefined') {
-              try {
-                // Safely check for store property on window
-                // @ts-ignore - The store is attached to window in store.js
-                const reduxStore = window.store;
-                
-                if (reduxStore && typeof reduxStore.dispatch === 'function') {
-                  const loginPayload = {
-                    isAuthenticated: true,
-                    profile: {
-                      email: userInfo.email,
-                      email_verified: userInfo.email_verified,
-                      sub: userInfo.sub,
-                      name: userInfo.name,
-                      given_name: userInfo.given_name,
-                      family_name: userInfo.family_name,
-                      nickname: userInfo.nickname,
-                      preferred_username: userInfo.preferred_username,
-                      groups: userInfo.groups || [],
-                      picture: userInfo.picture
-                    },
-                    tokens: {
-                      access_token: userInfo.access_token,
-                      id_token: userInfo.id_token,
-                      token_type: userInfo.token_type || 'Bearer',
-                      expires_at: userInfo.exp ? new Date(userInfo.exp * 1000).toISOString() : null
-                    }
-                  };
-                  
-                  console.log('Dispatching login action to Redux');
-                  reduxStore.dispatch({ type: 'user/login', payload: loginPayload });
-                } else {
-                  console.warn('Redux store not found on window or missing dispatch method');
-                }
-              } catch (reduxError) {
-                console.error('Error dispatching to Redux:', reduxError);
-              }
-            }
-          } catch (storageError) {
-            console.error('Error storing authentication data:', storageError);
-          }
-        } else {
-          console.warn('User info missing or invalid:', userInfo);
-        }
-        
-        // Determine where to redirect after successful authentication
-        const storedState = rawState ? JSON.parse(decodeURIComponent(rawState)) : null;
-        const redirectPath = storedState?.returnTo || '/Page';
-        
-        // Redirect back to the application
-        console.log('Authentication complete. Redirecting to:', redirectPath);
-        window.location.href = redirectPath;
-      } catch (error: unknown) {
-        const errorDetails = error instanceof Error 
-          ? {
-              errorName: error.name,
-              errorMessage: error.message,
-              errorStack: error.stack
-            }
-          : {
-              errorName: 'Unknown Error',
-              errorMessage: String(error),
-              errorStack: null
-            };
+      console.error('Token exchange failed:', {
+        status: response.status,
+        statusText: response.statusText,
+        error: errorJson || errorText,
+        headers: Object.fromEntries(response.headers.entries())
+      });
 
-        console.error('Authentication callback failed:', errorDetails);
+      // More descriptive error message
+      const errorDetail = errorJson ? `${errorJson.error}: ${errorJson.error_description || ''}` : errorText;
+      throw new Error(`Token exchange failed (${response.status}): ${errorDetail}`);
+    }
 
-        // Fallback redirect if something goes wrong - also redirect to /Page instead of root
-        console.log('Authentication failed. Redirecting to fallback: /Page');
-        window.location.href = '/Page';
-      }
+    const data = await response.json();
+    if (!data.access_token) {
+      throw new Error('No access token received');
     }
 
-    // Run the callback handler when the page loads
-    handleAuthCallback();
-  </script>
-</Layout>
+    // Redirect to the success page with token data
+    return Astro.redirect(`/auth/notion/success?access_token=${data.access_token}&workspace_id=${data.workspace_id}&workspace_name=${encodeURIComponent(data.workspace_name)}`);
+  } catch (err) {
+    console.error('OAuth error:', err);
+    error = err.message;
+  }
+}
+---
+
+<!DOCTYPE html>
+<html>
+<head>
+  <title>Notion OAuth Callback</title>
+</head>
+<body>
+  {error ? (
+    <div style="color: #e74c3c; padding: 20px; margin: 20px; background-color: #fadbd8; border-radius: 4px;">
+      ⚠️ {error}
+    </div>
+  ) : (
+    <div style="text-align: center; padding: 20px;">
+      <p>Processing authentication...</p>
+    </div>
+  )}
+</body>
+</html>

commit a3ce298391aa0fe182cf1f622418c42723af4e62
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:25:22 2025 +0800

    Update callback.astro

diff --git a/src/pages/auth/notion/callback.astro b/src/pages/auth/notion/callback.astro
index b33f317..091dfb7 100644
--- a/src/pages/auth/notion/callback.astro
+++ b/src/pages/auth/notion/callback.astro
@@ -1,72 +1,229 @@
-export async function post({ request }) {
-  try {
-    const body = await request.json();
-    const { code } = body;
-
-    if (!code) {
-      return new Response(JSON.stringify({
-        error: 'No authorization code provided'
-      }), {
-        status: 400,
-        headers: {
-          'Content-Type': 'application/json'
-        }
-      });
-    }
+---
+import Layout from '../layouts/BaseLayout.astro';
 
-    const clientId = import.meta.env.NOTION_CLIENT_ID;
-    const clientSecret = import.meta.env.NOTION_CLIENT_SECRET;
+// Remove the immediate server-side redirect to allow client-side code to run first
+---
 
-    if (!clientId || !clientSecret) {
-      return new Response(JSON.stringify({
-        error: 'Missing Notion credentials in environment variables'
-      }), {
-        status: 500,
-        headers: {
-          'Content-Type': 'application/json'
-        }
-      });
+<Layout title="Authentication Callback">
+  <!-- Immediate inline script for debugging -->
+  <script is:inline>
+    console.log('INLINE DEBUG: Script executing', {
+      time: new Date().toISOString(),
+      url: window.location.href,
+      code: new URLSearchParams(window.location.search).get('code') ? 'present' : 'missing'
+    });
+
+    // Store the redirect path in localStorage as early as possible
+    try {
+      localStorage.setItem('authentik_top_banner_authredirect_uri', '/Page');
+      console.log('INLINE DEBUG: Stored redirect path in localStorage');
+    } catch (storageError) {
+      console.error('INLINE DEBUG: Error storing redirect path:', storageError);
     }
+  </script>
+  
+  <div class="min-h-screen flex items-center justify-center">
+    <div class="text-center">
+      <h1 class="text-2xl font-semibold mb-4">Processing Authentication...</h1>
+      <p class="text-gray-600">You will be redirected back automatically.</p>
+    </div>
+  </div>
 
-    const tokenResponse = await fetch('https://api.notion.com/v1/oauth/token', {
-      method: 'POST',
-      headers: {
-        'Authorization': `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString('base64')}`,
-        'Content-Type': 'application/json',
-        'Notion-Version': '2022-06-28'
-      },
-      body: JSON.stringify({
-        grant_type: 'authorization_code',
-        code,
-        redirect_uri: 'http://localhost:4321/auth/notion/callback'
-      })
+  <script>
+    // Immediate logging to verify script execution
+    console.log('CALLBACK DEBUG: Script started', {
+      timestamp: new Date().toISOString(),
+      url: window.location.href
     });
 
-    if (!tokenResponse.ok) {
-      const error = await tokenResponse.text();
-      throw new Error(`Notion API error: ${error}`);
-    }
+    // Function to handle the authentication callback
+    async function handleAuthCallback() {
+      console.log('CALLBACK DEBUG: handleAuthCallback function called');
+      
+      try {
+        // Extract the authorization code from the URL and trim any whitespace
+        const urlParams = new URLSearchParams(window.location.search);
+        const rawCode = urlParams.get('code');
+        const rawState = urlParams.get('state');
+        const code = rawCode ? rawCode.trim() : null;
 
-    const tokenData = await tokenResponse.json();
+        // Detailed logging of all URL parameters
+        console.log('Authentication Callback Full URL Details:', {
+          fullUrl: window.location.href,
+          searchParams: Object.fromEntries(urlParams.entries())
+        });
 
-    return new Response(JSON.stringify({
-      success: true,
-      ...tokenData
-    }), {
-      status: 200,
-      headers: {
-        'Content-Type': 'application/json'
-      }
-    });
-  } catch (error) {
-    console.error('Notion callback error:', error);
-    return new Response(JSON.stringify({
-      error: error.message || 'Internal server error'
-    }), {
-      status: 500,
-      headers: {
-        'Content-Type': 'application/json'
+        if (!code) {
+          console.error('No authorization code found');
+          throw new Error('No authorization code present in the URL');
+        }
+
+        // Log detailed debug information
+        console.log('Authentication Callback Debug:', {
+          code: code ? 'Code Present' : 'No Code',
+          rawCode,
+          rawState,
+          origin: window.location.origin,
+          fullUrl: window.location.href,
+          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID ? 'Present' : 'Missing',
+          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
+          redirectUri: import.meta.env.PUBLIC_AUTHENTIK_REDIRECT_URI,
+          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET ? 'Present' : 'Missing'
+        });
+
+        // Import the Authentik client dynamically
+        console.log('CALLBACK DEBUG: About to import authentik client');
+        let createClient;
+        try {
+          const module = await import('../lib/authentik/client');
+          createClient = module.createClient;
+          console.log('CALLBACK DEBUG: Authentik client imported successfully');
+        } catch (importError: unknown) {
+          console.error('CALLBACK DEBUG: Failed to import authentik client', 
+            importError instanceof Error ? 
+              { message: importError.message, stack: importError.stack } : 
+              String(importError)
+          );
+          throw new Error(`Import failed: ${importError instanceof Error ? importError.message : String(importError)}`);
+        }
+
+        if (!createClient || typeof createClient !== 'function') {
+          console.error('CALLBACK DEBUG: createClient is not a function', { createClient });
+          throw new Error('createClient is not a function');
+        }
+
+        // Hardcode the redirect URI based on hostname for maximum reliability
+        const isLocalhost = window.location.hostname === 'localhost';
+        const hardcodedRedirectUri = isLocalhost ? 'http://localhost:4321/callback' : 'http://todo.pkc.pub/callback';
+
+        console.log('Callback page redirect URI check:', {
+          isLocalhost,
+          hardcodedRedirectUri,
+          currentUrl: window.location.href
+        });
+
+        // Create the Authentik client with the same configuration used in TopBar
+        const client = createClient({
+          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
+          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET || '',
+          redirectUri: hardcodedRedirectUri,
+          scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
+          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
+          storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+        });
+
+        // Handle the callback
+        console.log('CALLBACK DEBUG: About to call client.handleCallback');
+        const userInfo = await client.handleCallback(code);
+        
+        console.log('Authentication Successful:', {
+          userInfoReceived: !!userInfo,
+          userInfoFields: userInfo ? Object.keys(userInfo) : [],
+          accessTokenReceived: !!userInfo?.access_token
+        });
+        
+        // Explicitly store all user information in localStorage with multiple keys for redundancy
+        if (userInfo && typeof userInfo === 'object') {
+          try {
+            // Get the storage key prefix
+            const authStorageKeyPrefix = import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_';
+            
+            // Store user info in multiple formats to ensure it's found
+            localStorage.setItem(`${authStorageKeyPrefix}top_banner_authuser_info`, JSON.stringify(userInfo));
+            localStorage.setItem(`${authStorageKeyPrefix}user_info`, JSON.stringify(userInfo));
+            
+            // Store tokens separately for easier access
+            if (userInfo.access_token) {
+              localStorage.setItem(`${authStorageKeyPrefix}top_banner_authaccess_token`, userInfo.access_token);
+              localStorage.setItem(`${authStorageKeyPrefix}access_token`, userInfo.access_token);
+            }
+            
+            if (userInfo.id_token) {
+              localStorage.setItem(`${authStorageKeyPrefix}top_banner_authid_token`, userInfo.id_token);
+              localStorage.setItem(`${authStorageKeyPrefix}id_token`, userInfo.id_token);
+            }
+            
+            // Log successful storage
+            console.log('Authentication data stored successfully', {
+              keys: Object.keys(localStorage).filter(k => k.includes(authStorageKeyPrefix)),
+              userInfoSize: JSON.stringify(userInfo).length
+            });
+            
+            // Dispatch login action to Redux if possible
+            if (typeof window !== 'undefined') {
+              try {
+                // Safely check for store property on window
+                // @ts-ignore - The store is attached to window in store.js
+                const reduxStore = window.store;
+                
+                if (reduxStore && typeof reduxStore.dispatch === 'function') {
+                  const loginPayload = {
+                    isAuthenticated: true,
+                    profile: {
+                      email: userInfo.email,
+                      email_verified: userInfo.email_verified,
+                      sub: userInfo.sub,
+                      name: userInfo.name,
+                      given_name: userInfo.given_name,
+                      family_name: userInfo.family_name,
+                      nickname: userInfo.nickname,
+                      preferred_username: userInfo.preferred_username,
+                      groups: userInfo.groups || [],
+                      picture: userInfo.picture
+                    },
+                    tokens: {
+                      access_token: userInfo.access_token,
+                      id_token: userInfo.id_token,
+                      token_type: userInfo.token_type || 'Bearer',
+                      expires_at: userInfo.exp ? new Date(userInfo.exp * 1000).toISOString() : null
+                    }
+                  };
+                  
+                  console.log('Dispatching login action to Redux');
+                  reduxStore.dispatch({ type: 'user/login', payload: loginPayload });
+                } else {
+                  console.warn('Redux store not found on window or missing dispatch method');
+                }
+              } catch (reduxError) {
+                console.error('Error dispatching to Redux:', reduxError);
+              }
+            }
+          } catch (storageError) {
+            console.error('Error storing authentication data:', storageError);
+          }
+        } else {
+          console.warn('User info missing or invalid:', userInfo);
+        }
+        
+        // Determine where to redirect after successful authentication
+        const storedState = rawState ? JSON.parse(decodeURIComponent(rawState)) : null;
+        const redirectPath = storedState?.returnTo || '/Page';
+        
+        // Redirect back to the application
+        console.log('Authentication complete. Redirecting to:', redirectPath);
+        window.location.href = redirectPath;
+      } catch (error: unknown) {
+        const errorDetails = error instanceof Error 
+          ? {
+              errorName: error.name,
+              errorMessage: error.message,
+              errorStack: error.stack
+            }
+          : {
+              errorName: 'Unknown Error',
+              errorMessage: String(error),
+              errorStack: null
+            };
+
+        console.error('Authentication callback failed:', errorDetails);
+
+        // Fallback redirect if something goes wrong - also redirect to /Page instead of root
+        console.log('Authentication failed. Redirecting to fallback: /Page');
+        window.location.href = '/Page';
       }
-    });
-  }
-}
+    }
+
+    // Run the callback handler when the page loads
+    handleAuthCallback();
+  </script>
+</Layout>

commit e1e55691de8c4dff8c5fbc6580fa00df881a4da2
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 16:15:46 2025 +0800

    Create callback.astro

diff --git a/src/pages/auth/notion/callback.astro b/src/pages/auth/notion/callback.astro
new file mode 100644
index 0000000..b33f317
--- /dev/null
+++ b/src/pages/auth/notion/callback.astro
@@ -0,0 +1,72 @@
+export async function post({ request }) {
+  try {
+    const body = await request.json();
+    const { code } = body;
+
+    if (!code) {
+      return new Response(JSON.stringify({
+        error: 'No authorization code provided'
+      }), {
+        status: 400,
+        headers: {
+          'Content-Type': 'application/json'
+        }
+      });
+    }
+
+    const clientId = import.meta.env.NOTION_CLIENT_ID;
+    const clientSecret = import.meta.env.NOTION_CLIENT_SECRET;
+
+    if (!clientId || !clientSecret) {
+      return new Response(JSON.stringify({
+        error: 'Missing Notion credentials in environment variables'
+      }), {
+        status: 500,
+        headers: {
+          'Content-Type': 'application/json'
+        }
+      });
+    }
+
+    const tokenResponse = await fetch('https://api.notion.com/v1/oauth/token', {
+      method: 'POST',
+      headers: {
+        'Authorization': `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString('base64')}`,
+        'Content-Type': 'application/json',
+        'Notion-Version': '2022-06-28'
+      },
+      body: JSON.stringify({
+        grant_type: 'authorization_code',
+        code,
+        redirect_uri: 'http://localhost:4321/auth/notion/callback'
+      })
+    });
+
+    if (!tokenResponse.ok) {
+      const error = await tokenResponse.text();
+      throw new Error(`Notion API error: ${error}`);
+    }
+
+    const tokenData = await tokenResponse.json();
+
+    return new Response(JSON.stringify({
+      success: true,
+      ...tokenData
+    }), {
+      status: 200,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  } catch (error) {
+    console.error('Notion callback error:', error);
+    return new Response(JSON.stringify({
+      error: error.message || 'Internal server error'
+    }), {
+      status: 500,
+      headers: {
+        'Content-Type': 'application/json'
+      }
+    });
+  }
+}

commit 367ca62943feefc975d70c73318ec1f405344a70
Author: Alessandro Rumampuk <44091930+alessandrorumampuk@users.noreply.github.com>
Date:   Fri Jul 4 15:52:33 2025 +0800

    Update chatbot.jsx

diff --git a/src/components/panels/chatbot.jsx b/src/components/panels/chatbot.jsx
index f6efc62..bdc0ba9 100644
--- a/src/components/panels/chatbot.jsx
+++ b/src/components/panels/chatbot.jsx
@@ -24,19 +24,20 @@ const ChatbotPanel = ({ className = '' }) => {
 
   const [input, setInput] = useState('');
   const [isLoading, setIsLoading] = useState(false);
+  const [isSwitching, setIsSwitching] = useState(false);
+  const switchTimeoutRef = useRef(null);
   const [error, setError] = useState(null);
   const [models, setModels] = useState([]);
-  const [selectedModel, setSelectedModel] = useState('llama3:8b');
+  const [selectedModel, setSelectedModel] = useState('');
   const [selectedPort, setSelectedPort] = useState('11434');
   const [ollamaInstance, setOllamaInstance] = useState('local');
   const [instanceStatus, setInstanceStatus] = useState({
     local: { connected: false, models: [] },
-    docker: { connected: false, models: [] }
-  }); // 'local' or 'docker'
+    server: { connected: false, models: [] }
+  });
   
   const messagesEndRef = useRef(null);
   const inputRef = useRef(null);
-  const terminalSocketRef = useRef(null);
 
 
   // Scroll to bottom when messages change
@@ -168,36 +169,46 @@ const ChatbotPanel = ({ className = '' }) => {
   };
 
   const checkOllamaStatus = async () => {
-    const instance = selectedPort === '11434' ? 'local' : 'docker';
+    const instance = selectedPort === '11434' ? 'local' : 'server';
+
     setInstanceStatus(prev => ({
       ...prev,
       [instance]: { ...prev[instance], connected: false }
     }));
+
     try {
-      const response = await fetch(`http://127.0.0.1:${selectedPort}/api/tags`);
-      if (response.ok) {
-        const data = await response.json();
-        if (data.models && data.models.length > 0) {
-          const instance = selectedPort === '11434' ? 'local' : 'docker';
-          setModels(data.models);
-          setInstanceStatus(prev => ({
-            ...prev,
-            [instance]: { connected: true, models: data.models }
-          }));
-          // If llama3:8b is available, use it
-          const llama3Model = data.models.find(model => model.name === 'llama3:8b');
-          if (llama3Model) {
-            setSelectedModel('llama3:8b');
-          } else {
-            // Otherwise use the first available model
-            setSelectedModel(data.models[0].name);
-          }
-        }
+      // Try /api/list endpoint directly - it's more reliable
+      const response = await fetch(`http://127.0.0.1:${selectedPort}/api/tags`, {
+        signal: AbortSignal.timeout(2000) // 2 second timeout
+      });
+
+      if (!response.ok) {
+        throw new Error('Unable to fetch models');
+      }
+
+      const data = await response.json();
+      const models = data.models?.map(model => ({ name: model.name })) || [];
+
+      if (models.length > 0) {
+        setModels(models);
+        setInstanceStatus(prev => ({
+          ...prev,
+          [instance]: { connected: true, models: models }
+        }));
+        setSelectedModel(models[0].name);
+        setError(null);
+      } else {
+        throw new Error('No models available');
       }
     } catch (err) {
       console.error('Error checking Ollama status:', err);
-      const instanceType = selectedPort === '11434' ? 'local' : 'Docker';
-      setError(`Cannot connect to ${instanceType} Ollama server. Make sure ${instanceType} Ollama is running at http://127.0.0.1:${selectedPort}`);
+      const instanceType = selectedPort === '11434' ? 'Local LLM' : 'Server LLM';
+      const errorMessage = err.name === 'TimeoutError' 
+        ? `${instanceType} connection timed out. Make sure ${instanceType} is running.`
+        : `${instanceType} is not available. Make sure ${instanceType} is running and has models installed.`;
+      setError(errorMessage);
+      setModels([]);
+      setSelectedModel('');
     }
   };
 
@@ -227,138 +238,7 @@ const ChatbotPanel = ({ className = '' }) => {
     }
   };
 
-  useEffect(() => {
-    // Connect to terminal WebSocket server
-    connectToTerminal();
-    return () => {
-      if (terminalSocketRef.current) {
-        terminalSocketRef.current.close();
-      }
-    };
-  }, []);
-
-  const connectToTerminal = () => {
-    try {
-      const ws = new WebSocket('ws://localhost:3001');
-      terminalSocketRef.current = ws;
-
-      ws.onmessage = (event) => {
-        const message = JSON.parse(event.data);
-        if (message.type === 'output') {
-          setMessages(prev => [...prev, {
-            role: 'assistant',
-            content: message.data
-          }]);
-        }
-      };
-    } catch (err) {
-      console.error('Terminal connection error:', err);
-    }
-  };
-
-  // Add this function after other function declarations
-  // Update the processNaturalLanguageCommand function
-  const processNaturalLanguageCommand = (text) => {
-    // Helper function to calculate similarity between two strings
-    const calculateSimilarity = (str1, str2) => {
-      const s1 = str1.toLowerCase();
-      const s2 = str2.toLowerCase();
-      const len1 = s1.length;
-      const len2 = s2.length;
-      const matrix = Array(len1 + 1).fill().map(() => Array(len2 + 1).fill(0));
-
-      for (let i = 0; i <= len1; i++) matrix[i][0] = i;
-      for (let j = 0; j <= len2; j++) matrix[0][j] = j;
-
-      for (let i = 1; i <= len1; i++) {
-        for (let j = 1; j <= len2; j++) {
-          const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
-          matrix[i][j] = Math.min(
-            matrix[i - 1][j] + 1,
-            matrix[i][j - 1] + 1,
-            matrix[i - 1][j - 1] + cost
-          );
-        }
-      }
-      return 1 - (matrix[len1][len2] / Math.max(len1, len2));
-    };
-
-    // Find closest matching command
-    const findClosestCommand = (input) => {
-      const commands = Object.keys(commandMap);
-      let bestMatch = null;
-      let highestSimilarity = 0;
-
-      commands.forEach(cmd => {
-        const similarity = calculateSimilarity(input, cmd);
-        if (similarity > highestSimilarity && similarity > 0.6) { // Threshold of 60% similarity
-          highestSimilarity = similarity;
-          bestMatch = cmd;
-        }
-      });
-      return bestMatch;
-    };
-
-    const commandMap = {
-      'read': 'cat',
-      'show': 'cat',
-      'list': 'ls',
-      'show files': 'ls',
-      'show directory': 'ls',
-      'current directory': 'pwd',
-      'where am i': 'pwd',
-      'clear screen': 'clear',
-      'make directory': 'mkdir',
-      'create directory': 'mkdir',
-      'remove': 'rm',
-      'delete': 'rm',
-    };
-
-    // Fuzzy patterns for file operations
-    const patterns = {
-      read: /(?:r[ea]+d|sh[o0]w|d[i1]spl[ae]y|[o0]p[e3]n)\s+(?:c[o0]nt[e3]nts?\s+[o0]f\s+|th[e3]\s+)?(?:f[i1]l[e3]\s+)?["']?([^"']+?)["']?\s*$/i,
-      list: /(?:l[i1]st|sh[o0]w)\s+(?:f[i1]l[e3]s?|d[i1]r[e3]ct[o0]r[yi]?s?|c[o0]nt[e3]nts?)\s*(?:[i1]n\s+)?(.+)?/i,
-      mkdir: /(?:m[a4]k[e3]|cr[e3][a4]t[e3])\s+(?:[a4]\s+)?(?:n[e3]w\s+)?d[i1]r(?:[e3]ct[o0]r[yi])?\s+(?:n[a4]m[e3]d\s+)?(.+)/i,
-      remove: /(?:r[e3]m[o0]v[e3]|d[e3]l[e3]t[e3])\s+(?:th[e3]\s+)?(?:f[i1]l[e3]|d[i1]r[e3]ct[o0]r[yi])?\s+(.+)/i,
-      where: /w[he]{1,2}r[e]?\s+(?:am|is)\s+(?:i|me|we)/i
-    };
-
-    let command = '';
-    const input = text.toLowerCase().trim();
-
-    // First try to find exact match
-    if (commandMap[input]) {
-      return commandMap[input];
-    }
-
-    // Then try to find closest match for simple commands
-    const closestMatch = findClosestCommand(input);
-    if (closestMatch) {
-      return commandMap[closestMatch];
-    }
-
-    // Check patterns with fuzzy matching
-    if (patterns.where.test(input)) {
-      command = 'pwd';
-    } else if (patterns.read.test(input)) {
-      const match = input.match(patterns.read);
-      const filename = match[1].trim();
-      command = `cat "${filename}"`;
-    } else if (patterns.list.test(input)) {
-      const match = input.match(patterns.list);
-      command = `ls ${match[1] ? `"${match[1].trim()}"` : ''}`.trim();
-    } else if (patterns.mkdir.test(input)) {
-      const match = input.match(patterns.mkdir);
-      command = `mkdir "${match[1].trim()}"`;
-    } else if (patterns.remove.test(input)) {
-      const match = input.match(patterns.remove);
-      command = `rm "${match[1].trim()}"`;
-    }
 
-    return command;
-  };
-  
-  // Update the sendMessage function's command handling section
   const sendMessage = async () => {
     if (!input.trim() || isLoading) return;
   
@@ -369,19 +249,7 @@ const ChatbotPanel = ({ className = '' }) => {
     setIsLoading(true);
     setError(null);
   
-    // Check for terminal commands (both direct and natural language)
-    const naturalCommand = processNaturalLanguageCommand(input.trim());
-    if (input.trim().startsWith('$') || naturalCommand) {
-      const command = input.trim().startsWith('$') ? input.trim().slice(1) : naturalCommand;
-      if (terminalSocketRef.current?.readyState === WebSocket.OPEN) {
-        terminalSocketRef.current.send(JSON.stringify({
-          type: 'input',
-          data: command + '\n'
-        }));
-      }
-      setIsLoading(false);
-      return;
-    }
+
 
     try {
       // Add thinking indicator
@@ -531,19 +399,60 @@ Answer based on the above context.`
     <div className={`h-full w-full flex flex-col bg-gray-900 text-gray-200 overflow-hidden ${className}`}>
       <div className="p-2 bg-gray-800 border-b border-gray-700 flex flex-col">
         <div className="flex items-center mb-2">
-          <div className="text-center flex-grow"><b>Chatbot ({ollamaInstance === 'local' ? 'Local' : 'Docker'})</b></div>
-          <select 
-            value={selectedPort}
-            onChange={(e) => {
-              const port = e.target.value;
-              setSelectedPort(port);
-              setOllamaInstance(port === '11434' ? 'local' : 'docker');
-            }}
-            className="mr-2 px-2 py-1 text-xs bg-gray-700 text-white rounded"
-          >
-            <option value="11434">Your Local Ollama</option>
-            <option value="11435">Docker Server</option>
-          </select>
+          <div className="text-center flex-grow"><b>Chatbot</b></div>
+          <div className="flex items-center mr-2">
+            <span className="text-xs text-gray-300 font-medium mr-3">LLM Provider:</span>
+            <button
+              disabled={isSwitching}
+              onClick={() => {
+                // Prevent concurrent switches
+                if (isSwitching) return;
+
+                // Clear any pending switch timeout
+                if (switchTimeoutRef.current) {
+                  clearTimeout(switchTimeoutRef.current);
+                }
+
+                // Set a 100ms debounce timeout
+                switchTimeoutRef.current = setTimeout(async () => {
+                  setIsSwitching(true);
+                  try {
+                    const newPort = selectedPort === '11434' ? '11435' : '11434';
+                    const newInstance = selectedPort === '11434' ? 'server' : 'local';
+
+                    // Batch state updates
+                    setModels([]);
+                    setError(null);
+                    setIsLoading(false);
+                    setMessages(prev => prev.filter(m => !m.isThinking));
+                    setSelectedPort(newPort);
+                    setOllamaInstance(newInstance);
+
+                    await checkOllamaStatus();
+                  } catch (err) {
+                    console.error('Switch error:', err);
+                    setError(`Failed to switch LLM provider: ${err.message}`);
+                  } finally {
+                    setIsSwitching(false);
+                    switchTimeoutRef.current = null;
+                  }
+                }, 100);
+              }}
+              className={`flex items-center gap-2 px-3 py-1 text-xs ${isSwitching ? 'bg-gray-600 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-600'} text-white rounded transition-colors duration-200 min-w-[80px] text-center font-medium`}
+            >
+              <div className="flex items-center gap-2">
+                <div className="relative h-4 w-6 flex justify-between px-0">
+                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="white">
+                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
+                  </svg>
+                  <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="white">
+                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
+                  </svg>
+                </div>
+                <span className="min-w-[36px]">{selectedPort === '11434' ? 'Local' : 'Server'}</span>
+              </div>
+            </button>
+          </div>
           <select 
             value={selectedModel}
             onChange={handleModelChange}
@@ -556,7 +465,7 @@ Answer based on the above context.`
                 </option>
               ))
             ) : (
-              <option key="llama3:8b" value="llama3:8b">llama3:8b</option>
+              <option key="LLM Models" value="LLM Models">LLM Models</option>
             )}
           </select>
           <button 
```
