# Git Activity Log - Henry Koo
Generated at: Mon Mar 17 00:43:44 UTC 2025
## Changes by Henry Koo
```diff
commit 900ba89836c88e9c069b9cddc5f11d92ac6faa9e
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 20:40:12 2025 +0800

    working redux

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 418e105..a6ace74 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -1,8 +1,9 @@
-import React, { useState, useEffect, useCallback } from 'react';
-import { FiSun, FiMoon, FiLogOut, FiUser } from 'react-icons/fi';
+import React, { useState, useEffect } from 'react';
+import { FiSun, FiMoon, FiLogOut } from 'react-icons/fi';
 import { store } from '../../store';
 import { toggleTheme } from '../../features/themeSlice';
 import { createClient } from '../../lib/authentik/client';
+import { login, logout } from '../../features/userSlice';
 
 interface TopBarProps {
   initialTheme?: 'light' | 'dark';
@@ -18,8 +19,8 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
   const [theme, setTheme] = useState<'light' | 'dark'>(initialPropTheme || 'light');
   const [loading, setLoading] = useState(false);
   const [redirectUri, setRedirectUri] = useState('');
-  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);
-  const [isHydrated, setIsHydrated] = useState(false);
+  const [isAuthenticated, setIsAuthenticated] = useState(false);
+  const [userProfile, setUserProfile] = useState<UserInfo>({});
 
   useEffect(() => {
     // Initial theme setup
@@ -41,21 +42,44 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
 
     // Check for stored user info
     const storedUserInfo = localStorage.getItem('authentik_panel_top_banner_authuser_info');
-    console.log('Stored User Info:', storedUserInfo); // Debugging log
+    const accessToken = localStorage.getItem('authentik_panel_top_banner_auth_access_token');
+    const idToken = localStorage.getItem('authentik_panel_top_banner_auth_id_token');
+
+    console.log('Stored User Info:', {
+      userInfo: storedUserInfo,
+      accessToken,
+      idToken
+    });
 
     if (storedUserInfo) {
       try {
         const parsedUserInfo: UserInfo = JSON.parse(storedUserInfo);
-        setUserInfo(parsedUserInfo);
-        console.log('Parsed User Info:', parsedUserInfo);
+        
+        // Dispatch login action with comprehensive payload
+        const loginPayload = {
+          profile: parsedUserInfo,
+          tokens: {
+            access_token: accessToken,
+            id_token: idToken,
+            // Add other token details if available
+          }
+        };
+
+        console.log('Dispatching Login Payload:', loginPayload);
+
+        // Dispatch login action
+        const loginAction = store.dispatch(login(loginPayload));
+
+        // Update local state
+        setIsAuthenticated(true);
+        setUserProfile(parsedUserInfo);
+
+        console.log('Login dispatched with action:', loginAction);
       } catch (error) {
         console.error('Error parsing user info:', error);
       }
     }
 
-    // Mark as hydrated
-    setIsHydrated(true);
-
     return () => {
       unsubscribeTheme();
     };
@@ -84,21 +108,18 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
   };
 
   const handleLogout = () => {
+    // Remove stored user info
     localStorage.removeItem('authentik_panel_top_banner_authuser_info');
+    localStorage.removeItem('authentik_panel_top_banner_auth_access_token');
+    localStorage.removeItem('authentik_panel_top_banner_auth_id_token');
     
-    setUserInfo(null);
-  };
+    // Dispatch logout action
+    store.dispatch(logout());
 
-  // If not hydrated, return a minimal placeholder to prevent hydration mismatches
-  if (!isHydrated) {
-    return (
-      <div className="w-full h-14 bg-background border-b flex items-center justify-between px-6 shadow-sm">
-        <div className="flex items-center space-x-4">
-          <h1 className="text-xl font-semibold text-foreground">Redux Todo App</h1>
-        </div>
-      </div>
-    );
-  }
+    // Update local state
+    setIsAuthenticated(false);
+    setUserProfile({});
+  };
 
   return (
     <div className="w-full h-14 bg-background border-b flex items-center justify-between px-6 shadow-sm">
@@ -106,13 +127,13 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
         <h1 className="text-xl font-semibold text-foreground">Redux Todo App</h1>
       </div>
       <div className="flex items-center space-x-4">
-        {userInfo ? (
+        {isAuthenticated ? (
           <div className="flex items-center space-x-2">
             <div className="flex flex-col items-end">
               <span className="text-sm font-medium text-foreground">
-                {userInfo.email}
+                {userProfile.email}
               </span>
-              {userInfo.email_verified && (
+              {userProfile.email_verified && (
                 <span className="text-xs text-green-600">Verified</span>
               )}
             </div>
diff --git a/src/features/userSlice.js b/src/features/userSlice.js
index ce18fe1..fe18b44 100644
--- a/src/features/userSlice.js
+++ b/src/features/userSlice.js
@@ -1,30 +1,30 @@
 import { createSlice, createSelector } from '@reduxjs/toolkit';
 
-// Initial user state
+// Initial user state matching Authentik user info
 const initialState = {
   isAuthenticated: false,
   profile: {
-    id: null,
-    username: null,
+    sub: null,
     email: null,
-    avatar: null,
-  },
-  preferences: {
-    language: 'en',
-    notifications: {
-      email: true,
-      push: false,
-    },
-    theme: 'system', // system, light, dark
+    email_verified: false,
+    name: null,
+    given_name: null,
+    family_name: null,
+    nickname: null,
+    preferred_username: null,
+    groups: [],
+    picture: null,
   },
   session: {
-    token: null,
+    access_token: null,
+    id_token: null,
+    token_type: null,
+    expires_at: null,
     lastLogin: null,
-    loginAttempts: 0,
   },
-  permissions: {
-    roles: [],
-    capabilities: [],
+  preferences: {
+    theme: 'system', // system, light, dark
+    language: 'en',
   }
 };
 
@@ -32,27 +32,53 @@ export const userSlice = createSlice({
   name: 'user',
   initialState,
   reducers: {
-    // Login action
+    // Login action using full Authentik user info
     login: (state, action) => {
-      const { profile, token } = action.payload;
+      const { 
+        profile,  // Authentik user profile
+        tokens    // Authentication tokens
+      } = action.payload;
+
+      console.log('Login Action Payload:', { profile, tokens });
+
+      // Explicitly set authentication state to true
       state.isAuthenticated = true;
-      state.profile = { ...state.profile, ...profile };
-      state.session.token = token;
-      state.session.lastLogin = new Date().toISOString();
-      state.session.loginAttempts = 0;
+
+      // Spread Authentik profile information
+      state.profile = { 
+        ...initialState.profile,
+        ...profile 
+      };
+
+      // Update session tokens and login time
+      state.session = {
+        access_token: tokens?.access_token || null,
+        id_token: tokens?.id_token || null,
+        token_type: tokens?.token_type || null,
+        expires_at: tokens?.expires_at || 
+          (tokens?.expires_in 
+            ? new Date(Date.now() + tokens.expires_in * 1000).toISOString() 
+            : null),
+        lastLogin: new Date().toISOString()
+      };
+
+      console.log('Updated User State:', state);
     },
 
     // Logout action
     logout: (state) => {
       state.isAuthenticated = false;
       state.profile = initialState.profile;
-      state.session.token = null;
-      state.session.lastLogin = null;
+      state.session = initialState.session;
+      state.preferences = initialState.preferences;
     },
 
     // Update user profile
     updateProfile: (state, action) => {
-      state.profile = { ...state.profile, ...action.payload };
+      state.profile = { 
+        ...state.profile, 
+        ...action.payload 
+      };
     },
 
     // Update user preferences
@@ -63,14 +89,6 @@ export const userSlice = createSlice({
       };
     },
 
-    // Update user permissions
-    updatePermissions: (state, action) => {
-      state.permissions = {
-        ...state.permissions,
-        ...action.payload
-      };
-    },
-
     // Increment login attempts
     incrementLoginAttempts: (state) => {
       state.session.loginAttempts += 1;
@@ -89,14 +107,29 @@ export const selectUserProfile = createSelector(
   (user) => user.profile
 );
 
-export const selectUserPreferences = createSelector(
+export const selectUserEmail = createSelector(
   [(state) => state.user],
-  (user) => user.preferences
+  (user) => user.profile.email
+);
+
+export const selectEmailVerified = createSelector(
+  [(state) => state.user],
+  (user) => user.profile.email_verified
 );
 
-export const selectUserPermissions = createSelector(
+export const selectUserGroups = createSelector(
   [(state) => state.user],
-  (user) => user.permissions
+  (user) => user.profile.groups
+);
+
+export const selectUserSession = createSelector(
+  [(state) => state.user],
+  (user) => user.session
+);
+
+export const selectUserPreferences = createSelector(
+  [(state) => state.user],
+  (user) => user.preferences
 );
 
 export const { 
@@ -104,7 +137,6 @@ export const {
   logout, 
   updateProfile, 
   updatePreferences,
-  updatePermissions,
   incrementLoginAttempts 
 } = userSlice.actions;
 

commit 3ea885724295e91e6d839727bc2d240a771f6a6f
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 19:05:33 2025 +0800

    working topbar

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index d884bb5..418e105 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -40,12 +40,14 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
     setRedirectUri(`${origin}${path}`);
 
     // Check for stored user info
-    const storedUserInfo = localStorage.getItem('authentik_top_banner_auth_user_info');
+    const storedUserInfo = localStorage.getItem('authentik_panel_top_banner_authuser_info');
+    console.log('Stored User Info:', storedUserInfo); // Debugging log
+
     if (storedUserInfo) {
       try {
         const parsedUserInfo: UserInfo = JSON.parse(storedUserInfo);
         setUserInfo(parsedUserInfo);
-        console.log('Loaded user info:', parsedUserInfo);
+        console.log('Parsed User Info:', parsedUserInfo);
       } catch (error) {
         console.error('Error parsing user info:', error);
       }
@@ -71,7 +73,7 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
         redirectUri: redirectUri || '',
         scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
         baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
-        storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+        storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}panel_top_banner_auth`,
       });
 
       await client.login(currentPath);
@@ -82,9 +84,7 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
   };
 
   const handleLogout = () => {
-    localStorage.removeItem('authentik_top_banner_auth_access_token');
-    localStorage.removeItem('authentik_top_banner_auth_id_token');
-    localStorage.removeItem('authentik_top_banner_auth_user_info');
+    localStorage.removeItem('authentik_panel_top_banner_authuser_info');
     
     setUserInfo(null);
   };

commit 696e714d0cb175b7c235f2a2f03d285a345764d9
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 18:56:06 2025 +0800

    better topbar

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 8bb826e..d884bb5 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -10,15 +10,8 @@ interface TopBarProps {
 
 interface UserInfo {
   email?: string;
-  name?: string;
   email_verified?: boolean;
   sub?: string;
-  preferred_username?: string;
-  given_name?: string;
-  family_name?: string;
-  picture?: string;
-  nickname?: string;
-  groups?: string[];
 }
 
 export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }) => {
@@ -96,25 +89,6 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
     setUserInfo(null);
   };
 
-  // Determine the most appropriate display name
-  const getUserDisplayName = () => {
-    if (userInfo) {
-      return (
-        userInfo.name || 
-        userInfo.nickname ||
-        userInfo.preferred_username || 
-        userInfo.email || 
-        `User ${userInfo.sub?.slice(-4)}`
-      );
-    }
-    return 'User';
-  };
-
-  // Get user's group information
-  const getUserGroups = () => {
-    return userInfo?.groups?.join(', ') || 'No Groups';
-  };
-
   // If not hydrated, return a minimal placeholder to prevent hydration mismatches
   if (!isHydrated) {
     return (
@@ -136,16 +110,11 @@ export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }
           <div className="flex items-center space-x-2">
             <div className="flex flex-col items-end">
               <span className="text-sm font-medium text-foreground">
-                {getUserDisplayName()}
+                {userInfo.email}
               </span>
-              <div className="flex items-center space-x-1">
-                {userInfo.email_verified && (
-                  <span className="text-xs text-green-600">Verified</span>
-                )}
-                <span className="text-xs text-gray-500">
-                  ({getUserGroups()})
-                </span>
-              </div>
+              {userInfo.email_verified && (
+                <span className="text-xs text-green-600">Verified</span>
+              )}
             </div>
             <button 
               onClick={handleLogout}

commit 9505562f59d42f9242918735b5c7cddf61bc95fe
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 17:18:42 2025 +0800

    working storage

diff --git a/src/components/panels/ActionLogPanelReact.jsx b/src/components/panels/ActionLogPanelReact.jsx
index 4b3ffdf..8571f38 100644
--- a/src/components/panels/ActionLogPanelReact.jsx
+++ b/src/components/panels/ActionLogPanelReact.jsx
@@ -1,4 +1,4 @@
-import React, { useEffect, useRef } from 'react';
+import React, { useEffect, useRef, useState } from 'react';
 import { useSelector } from 'react-redux';
 import { selectActionHistory } from '../../features/todoSlice';
 import { selectThemeMode } from '../../features/themeSlice';
@@ -30,9 +30,14 @@ const getContentIcon = (content) => {
 const ActionLogPanelReact = () => {
   const actionHistory = useSelector(selectActionHistory);
   const themeMode = useSelector(selectThemeMode);
-  const isDark = themeMode === 'dark';
+  const [isDark, setIsDark] = useState(themeMode === 'dark');
   const scrollRef = useRef(null);
 
+  // Ensure consistent theme state
+  useEffect(() => {
+    setIsDark(themeMode === 'dark');
+  }, [themeMode]);
+
   // Auto-scroll to the latest action when new actions are added
   useEffect(() => {
     if (scrollRef.current) {
diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 30d5520..8bb826e 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -1,48 +1,39 @@
 import React, { useState, useEffect, useCallback } from 'react';
-import { FiSun, FiMoon, FiUser, FiLogOut } from 'react-icons/fi';
+import { FiSun, FiMoon, FiLogOut, FiUser } from 'react-icons/fi';
 import { store } from '../../store';
 import { toggleTheme } from '../../features/themeSlice';
 import { createClient } from '../../lib/authentik/client';
 
-export const TopBar: React.FC = () => {
-  const [isClient, setIsClient] = useState(false);
-  const [theme, setTheme] = useState(() => {
-    if (typeof window !== 'undefined') {
-      return store.getState().theme?.mode || 'light';
-    }
-    return 'light';
-  });
+interface TopBarProps {
+  initialTheme?: 'light' | 'dark';
+}
+
+interface UserInfo {
+  email?: string;
+  name?: string;
+  email_verified?: boolean;
+  sub?: string;
+  preferred_username?: string;
+  given_name?: string;
+  family_name?: string;
+  picture?: string;
+  nickname?: string;
+  groups?: string[];
+}
+
+export const TopBar: React.FC<TopBarProps> = ({ initialTheme: initialPropTheme }) => {
+  const [theme, setTheme] = useState<'light' | 'dark'>(initialPropTheme || 'light');
   const [loading, setLoading] = useState(false);
   const [redirectUri, setRedirectUri] = useState('');
-  const [userInfo, setUserInfo] = useState<{
-    email?: string;
-    name?: string;
-    email_verified?: boolean;
-  } | null>(null);
+  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);
+  const [isHydrated, setIsHydrated] = useState(false);
 
   useEffect(() => {
-    setIsClient(true);
-    
-    if (typeof window !== 'undefined') {
-      const origin = window.location.origin;
-      const path = '/callback';
-      setRedirectUri(`${origin}${path}`);
-
-      // Check for stored user info on component mount
-      const storedUserInfo = localStorage.getItem('authentik_top_banner_auth_user_info');
-      if (storedUserInfo) {
-        try {
-          const parsedUserInfo = JSON.parse(storedUserInfo);
-          setUserInfo(parsedUserInfo);
-          console.log('Loaded user info:', parsedUserInfo);
-        } catch (error) {
-          console.error('Error parsing user info:', error);
-        }
-      }
-    }
-  }, []);
+    // Initial theme setup
+    const storeTheme = store.getState().theme?.mode || 'light';
+    setTheme(storeTheme);
 
-  useEffect(() => {
+    // Set up theme subscription
     const unsubscribeTheme = store.subscribe(() => {
       const currentTheme = store.getState().theme?.mode;
       if (currentTheme && currentTheme !== theme) {
@@ -50,6 +41,26 @@ export const TopBar: React.FC = () => {
       }
     });
 
+    // Set up redirect URI
+    const origin = window.location.origin;
+    const path = '/callback';
+    setRedirectUri(`${origin}${path}`);
+
+    // Check for stored user info
+    const storedUserInfo = localStorage.getItem('authentik_top_banner_auth_user_info');
+    if (storedUserInfo) {
+      try {
+        const parsedUserInfo: UserInfo = JSON.parse(storedUserInfo);
+        setUserInfo(parsedUserInfo);
+        console.log('Loaded user info:', parsedUserInfo);
+      } catch (error) {
+        console.error('Error parsing user info:', error);
+      }
+    }
+
+    // Mark as hydrated
+    setIsHydrated(true);
+
     return () => {
       unsubscribeTheme();
     };
@@ -59,19 +70,7 @@ export const TopBar: React.FC = () => {
     try {
       setLoading(true);
       
-      const currentPath = typeof window !== 'undefined' 
-        ? window.location.pathname + window.location.search 
-        : '/';
-
-      console.log('Authentik Config:', {
-        clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID,
-        clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET,
-        redirectUri,
-        scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES,
-        baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
-        storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
-        currentPath,
-      });
+      const currentPath = window.location.pathname + window.location.search;
 
       const client = createClient({
         clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
@@ -90,17 +89,34 @@ export const TopBar: React.FC = () => {
   };
 
   const handleLogout = () => {
-    // Clear user info from localStorage
     localStorage.removeItem('authentik_top_banner_auth_access_token');
     localStorage.removeItem('authentik_top_banner_auth_id_token');
     localStorage.removeItem('authentik_top_banner_auth_user_info');
     
-    // Update state
     setUserInfo(null);
   };
 
-  // Only render client-side specific content when on the client
-  if (!isClient) {
+  // Determine the most appropriate display name
+  const getUserDisplayName = () => {
+    if (userInfo) {
+      return (
+        userInfo.name || 
+        userInfo.nickname ||
+        userInfo.preferred_username || 
+        userInfo.email || 
+        `User ${userInfo.sub?.slice(-4)}`
+      );
+    }
+    return 'User';
+  };
+
+  // Get user's group information
+  const getUserGroups = () => {
+    return userInfo?.groups?.join(', ') || 'No Groups';
+  };
+
+  // If not hydrated, return a minimal placeholder to prevent hydration mismatches
+  if (!isHydrated) {
     return (
       <div className="w-full h-14 bg-background border-b flex items-center justify-between px-6 shadow-sm">
         <div className="flex items-center space-x-4">
@@ -120,11 +136,16 @@ export const TopBar: React.FC = () => {
           <div className="flex items-center space-x-2">
             <div className="flex flex-col items-end">
               <span className="text-sm font-medium text-foreground">
-                {userInfo.name || userInfo.email}
+                {getUserDisplayName()}
               </span>
-              {userInfo.email_verified && (
-                <span className="text-xs text-green-600">Verified</span>
-              )}
+              <div className="flex items-center space-x-1">
+                {userInfo.email_verified && (
+                  <span className="text-xs text-green-600">Verified</span>
+                )}
+                <span className="text-xs text-gray-500">
+                  ({getUserGroups()})
+                </span>
+              </div>
             </div>
             <button 
               onClick={handleLogout}
diff --git a/src/layouts/DefaultLayout.astro b/src/layouts/DefaultLayout.astro
index b1a161f..573c41a 100644
--- a/src/layouts/DefaultLayout.astro
+++ b/src/layouts/DefaultLayout.astro
@@ -15,7 +15,7 @@ const initialTheme = store.getState().theme?.mode || 'light';
 ---
 
 <!doctype html>
-<html lang="en" class={initialTheme}>
+<html lang="en" class:list={[initialTheme, 'min-h-screen']}>
 	<head>
 		<meta charset="UTF-8" />
 		<meta name="description" content="Astro description" />
@@ -23,9 +23,14 @@ const initialTheme = store.getState().theme?.mode || 'light';
 		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
 		<meta name="generator" content={Astro.generator} />
 		<title>{title}</title>
+		<script define:vars={{initialTheme}}>
+			// Ensure consistent theme on initial load
+			document.documentElement.classList.remove('light', 'dark');
+			document.documentElement.classList.add(initialTheme);
+		</script>
 	</head>
 	<body class="min-h-screen bg-background text-foreground antialiased">
-		<TopBar client:load />
+		<TopBar client:load initial-theme={initialTheme} />
 		<ResizablePanels>
 			<Sidebar slot="sidebar" />
 			<PanelGroupLayout client:load />

commit ce5c87a4590d720ab87b1a2fff22247641bbd867
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 17:06:57 2025 +0800

    better topbar

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 91aec1b..30d5520 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -1,5 +1,5 @@
 import React, { useState, useEffect, useCallback } from 'react';
-import { FiSun, FiMoon } from 'react-icons/fi';
+import { FiSun, FiMoon, FiUser, FiLogOut } from 'react-icons/fi';
 import { store } from '../../store';
 import { toggleTheme } from '../../features/themeSlice';
 import { createClient } from '../../lib/authentik/client';
@@ -14,14 +14,31 @@ export const TopBar: React.FC = () => {
   });
   const [loading, setLoading] = useState(false);
   const [redirectUri, setRedirectUri] = useState('');
+  const [userInfo, setUserInfo] = useState<{
+    email?: string;
+    name?: string;
+    email_verified?: boolean;
+  } | null>(null);
 
   useEffect(() => {
     setIsClient(true);
     
     if (typeof window !== 'undefined') {
       const origin = window.location.origin;
-      const path = '/callback'; // Ensure this matches your Authentik redirect configuration
+      const path = '/callback';
       setRedirectUri(`${origin}${path}`);
+
+      // Check for stored user info on component mount
+      const storedUserInfo = localStorage.getItem('authentik_top_banner_auth_user_info');
+      if (storedUserInfo) {
+        try {
+          const parsedUserInfo = JSON.parse(storedUserInfo);
+          setUserInfo(parsedUserInfo);
+          console.log('Loaded user info:', parsedUserInfo);
+        } catch (error) {
+          console.error('Error parsing user info:', error);
+        }
+      }
     }
   }, []);
 
@@ -42,12 +59,10 @@ export const TopBar: React.FC = () => {
     try {
       setLoading(true);
       
-      // Get the full current path, including any query parameters
       const currentPath = typeof window !== 'undefined' 
         ? window.location.pathname + window.location.search 
         : '/';
 
-      // Log the environment variables to debug
       console.log('Authentik Config:', {
         clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID,
         clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET,
@@ -74,6 +89,16 @@ export const TopBar: React.FC = () => {
     }
   };
 
+  const handleLogout = () => {
+    // Clear user info from localStorage
+    localStorage.removeItem('authentik_top_banner_auth_access_token');
+    localStorage.removeItem('authentik_top_banner_auth_id_token');
+    localStorage.removeItem('authentik_top_banner_auth_user_info');
+    
+    // Update state
+    setUserInfo(null);
+  };
+
   // Only render client-side specific content when on the client
   if (!isClient) {
     return (
@@ -91,19 +116,39 @@ export const TopBar: React.FC = () => {
         <h1 className="text-xl font-semibold text-foreground">Redux Todo App</h1>
       </div>
       <div className="flex items-center space-x-4">
-        <button 
-          onClick={handleLogin}
-          disabled={loading}
-          className={`
-            flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
-            ${loading 
-              ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
-              : 'bg-blue-100 text-blue-600 hover:bg-blue-200'}
-          `}
-          aria-label="Sign In"
-        >
-          {loading ? 'Signing In...' : 'Sign In'}
-        </button>
+        {userInfo ? (
+          <div className="flex items-center space-x-2">
+            <div className="flex flex-col items-end">
+              <span className="text-sm font-medium text-foreground">
+                {userInfo.name || userInfo.email}
+              </span>
+              {userInfo.email_verified && (
+                <span className="text-xs text-green-600">Verified</span>
+              )}
+            </div>
+            <button 
+              onClick={handleLogout}
+              className="text-red-500 hover:text-red-600"
+              aria-label="Sign Out"
+            >
+              <FiLogOut className="w-5 h-5" />
+            </button>
+          </div>
+        ) : (
+          <button 
+            onClick={handleLogin}
+            disabled={loading}
+            className={`
+              flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
+              ${loading 
+                ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
+                : 'bg-blue-100 text-blue-600 hover:bg-blue-200'}
+            `}
+            aria-label="Sign In"
+          >
+            {loading ? 'Signing In...' : 'Sign In'}
+          </button>
+        )}
         <button 
           onClick={() => store.dispatch(toggleTheme())}
           className="text-foreground hover:text-foreground/80"

commit ce0584193e5751396e8d2715f919999b84e38e21
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 17:04:46 2025 +0800

    better client.ts

diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index ead5548..3766ca6 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -181,6 +181,11 @@ export function createClient(config: AuthentikClientConfig) {
       let tokens;
       try {
         tokens = await tokenResponse.json();
+        console.log('Token Response Parsed:', {
+          hasAccessToken: !!tokens.access_token,
+          hasIdToken: !!tokens.id_token,
+          tokenKeys: Object.keys(tokens)
+        });
       } catch (parseError: unknown) {
         const errorDetails = parseError instanceof Error 
           ? {
@@ -244,6 +249,10 @@ export function createClient(config: AuthentikClientConfig) {
       }
 
       const userInfo = await userInfoResponse.json();
+      console.log('User Info Retrieved:', {
+        userInfoKeys: Object.keys(userInfo)
+      });
+
       localStorage.setItem(`${storageKey}user_info`, JSON.stringify(userInfo));
 
       // Redirect to the specific page

commit c1ea3e7c0671067b8d3d6ee21af257227d7830fa
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 16:59:40 2025 +0800

    better callback page

diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index 56e09d1..ead5548 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -83,32 +83,88 @@ export function createClient(config: AuthentikClientConfig) {
         throw new Error('Invalid Authentik base URL');
       }
 
+      // Validate input parameters
+      if (!code) {
+        throw new Error('Authorization code is required');
+      }
+      if (!clientId) {
+        throw new Error('Client ID is required');
+      }
+      if (!clientSecret) {
+        throw new Error('Client Secret is required');
+      }
+      if (!redirectUri) {
+        throw new Error('Redirect URI is required');
+      }
+
       // Exchange authorization code for tokens
       const tokenUrl = new URL(`${sanitizedBaseUrl}/application/o/token/`);
       
-      console.log('DEBUG TOKEN EXCHANGE:', {
+      console.log('DEBUG TOKEN EXCHANGE CONFIGURATION:', {
         tokenUrl: tokenUrl.toString(),
         clientId,
         redirectUri,
-        code: code ? 'Code Present' : 'No Code',
-        baseUrl: sanitizedBaseUrl
+        baseUrl: sanitizedBaseUrl,
+        codeLength: code.length,
+        clientSecretLength: clientSecret.length
       });
 
-      // Prepare token exchange parameters
-      const tokenParams = new URLSearchParams({
-        client_id: clientId,
-        client_secret: clientSecret,
-        redirect_uri: redirectUri,
-        grant_type: 'authorization_code',
-        code: code,
+      // Prepare token exchange parameters with explicit encoding
+      const tokenParams = new URLSearchParams();
+      tokenParams.append('client_id', clientId);
+      tokenParams.append('client_secret', clientSecret);
+      tokenParams.append('redirect_uri', redirectUri);
+      tokenParams.append('grant_type', 'authorization_code');
+      tokenParams.append('code', code);
+
+      // Log the exact parameters being sent
+      console.log('DEBUG TOKEN EXCHANGE PARAMS:', {
+        params: Object.fromEntries(tokenParams.entries())
       });
 
-      const tokenResponse = await fetch(tokenUrl.toString(), {
-        method: 'POST',
-        headers: {
-          'Content-Type': 'application/x-www-form-urlencoded',
-        },
-        body: tokenParams,
+      let tokenResponse;
+      try {
+        tokenResponse = await fetch(tokenUrl.toString(), {
+          method: 'POST',
+          headers: {
+            'Content-Type': 'application/x-www-form-urlencoded',
+            'Accept': 'application/json'
+          },
+          body: tokenParams.toString()
+        });
+      } catch (fetchError: unknown) {
+        const errorDetails = fetchError instanceof Error 
+          ? {
+              errorName: fetchError.name,
+              errorMessage: fetchError.message,
+              errorStack: fetchError.stack
+            }
+          : {
+              errorName: 'Unknown Fetch Error',
+              errorMessage: String(fetchError),
+              errorStack: null
+            };
+
+        console.error('Fetch Error during token exchange:', {
+          ...errorDetails,
+          tokenUrl: tokenUrl.toString(),
+          clientIdUsed: clientId,
+          redirectUriUsed: redirectUri
+        });
+        throw new Error(`Network error during token exchange: ${errorDetails.errorMessage}`);
+      }
+
+      // Log full response details for debugging
+      const responseHeaders = Object.fromEntries(tokenResponse.headers.entries());
+      const responseStatus = {
+        ok: tokenResponse.ok,
+        status: tokenResponse.status,
+        statusText: tokenResponse.statusText
+      };
+
+      console.log('Token Exchange Response Details:', {
+        ...responseStatus,
+        headers: responseHeaders
       });
 
       if (!tokenResponse.ok) {
@@ -116,27 +172,75 @@ export function createClient(config: AuthentikClientConfig) {
         console.error('Token Exchange Error:', {
           status: tokenResponse.status,
           statusText: tokenResponse.statusText,
-          errorBody: errorText
+          errorBody: errorText,
+          requestParams: Object.fromEntries(tokenParams)
         });
-        throw new Error(`Failed to exchange authorization code: ${errorText}`);
+        throw new Error(`Failed to exchange authorization code. Status: ${tokenResponse.status}, Error: ${errorText}`);
       }
 
-      const tokens = await tokenResponse.json();
+      let tokens;
+      try {
+        tokens = await tokenResponse.json();
+      } catch (parseError: unknown) {
+        const errorDetails = parseError instanceof Error 
+          ? {
+              errorName: parseError.name,
+              errorMessage: parseError.message,
+              errorStack: parseError.stack
+            }
+          : {
+              errorName: 'Unknown Parse Error',
+              errorMessage: String(parseError),
+              errorStack: null
+            };
+
+        console.error('Token Parse Error:', errorDetails);
+        throw new Error(`Failed to parse token response: ${errorDetails.errorMessage}`);
+      }
       
+      // Validate tokens
+      if (!tokens.access_token) {
+        throw new Error('No access token received');
+      }
+
       // Store tokens
       localStorage.setItem(`${storageKey}access_token`, tokens.access_token);
-      localStorage.setItem(`${storageKey}id_token`, tokens.id_token);
+      localStorage.setItem(`${storageKey}id_token`, tokens.id_token || '');
 
       // Fetch user info
       const userInfoUrl = new URL(`${sanitizedBaseUrl}/application/o/userinfo/`);
-      const userInfoResponse = await fetch(userInfoUrl.toString(), {
-        headers: {
-          'Authorization': `Bearer ${tokens.access_token}`,
-        },
-      });
+      let userInfoResponse;
+      try {
+        userInfoResponse = await fetch(userInfoUrl.toString(), {
+          headers: {
+            'Authorization': `Bearer ${tokens.access_token}`,
+          },
+        });
+      } catch (fetchError: unknown) {
+        const errorDetails = fetchError instanceof Error 
+          ? {
+              errorName: fetchError.name,
+              errorMessage: fetchError.message,
+              errorStack: fetchError.stack
+            }
+          : {
+              errorName: 'Unknown Fetch Error',
+              errorMessage: String(fetchError),
+              errorStack: null
+            };
+
+        console.error('Fetch User Info Error:', errorDetails);
+        throw new Error(`Network error fetching user info: ${errorDetails.errorMessage}`);
+      }
 
       if (!userInfoResponse.ok) {
-        throw new Error('Failed to fetch user info');
+        const errorText = await userInfoResponse.text();
+        console.error('User Info Fetch Error:', {
+          status: userInfoResponse.status,
+          statusText: userInfoResponse.statusText,
+          errorBody: errorText
+        });
+        throw new Error(`Failed to fetch user info. Status: ${userInfoResponse.status}, Error: ${errorText}`);
       }
 
       const userInfo = await userInfoResponse.json();
@@ -148,8 +252,20 @@ export function createClient(config: AuthentikClientConfig) {
       }
 
       return userInfo;
-    } catch (error) {
-      console.error('Authentication callback failed:', error);
+    } catch (error: unknown) {
+      const errorDetails = error instanceof Error 
+        ? {
+            errorName: error.name,
+            errorMessage: error.message,
+            errorStack: error.stack
+          }
+        : {
+            errorName: 'Unknown Error',
+            errorMessage: String(error),
+            errorStack: null
+          };
+
+      console.error('Authentication callback failed:', errorDetails);
       throw error;
     }
   };
diff --git a/src/pages/callback.astro b/src/pages/callback.astro
index 0d332d2..592ce14 100644
--- a/src/pages/callback.astro
+++ b/src/pages/callback.astro
@@ -14,9 +14,17 @@ import Layout from '../layouts/BaseLayout.astro';
     // Function to handle the authentication callback
     async function handleAuthCallback() {
       try {
-        // Extract the authorization code from the URL
+        // Extract the authorization code from the URL and trim any whitespace
         const urlParams = new URLSearchParams(window.location.search);
-        const code = urlParams.get('code');
+        const rawCode = urlParams.get('code');
+        const rawState = urlParams.get('state');
+        const code = rawCode ? rawCode.trim() : null;
+
+        // Detailed logging of all URL parameters
+        console.log('Authentication Callback Full URL Details:', {
+          fullUrl: window.location.href,
+          searchParams: Object.fromEntries(urlParams.entries())
+        });
 
         if (!code) {
           console.error('No authorization code found');
@@ -26,11 +34,14 @@ import Layout from '../layouts/BaseLayout.astro';
         // Log detailed debug information
         console.log('Authentication Callback Debug:', {
           code: code ? 'Code Present' : 'No Code',
+          rawCode,
+          rawState,
           origin: window.location.origin,
           fullUrl: window.location.href,
           clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID ? 'Present' : 'Missing',
           baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
-          redirectUri: `${window.location.origin}/callback`
+          redirectUri: `${window.location.origin}/callback`,
+          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET ? 'Present' : 'Missing'
         });
 
         // Import the Authentik client dynamically

commit a798c46b865c69b05c6c31758d42c27f387633f4
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 16:52:25 2025 +0800

    better logging

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index d7755fd..91aec1b 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -50,6 +50,7 @@ export const TopBar: React.FC = () => {
       // Log the environment variables to debug
       console.log('Authentik Config:', {
         clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID,
+        clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET,
         redirectUri,
         scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES,
         baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
@@ -59,6 +60,7 @@ export const TopBar: React.FC = () => {
 
       const client = createClient({
         clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
+        clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET || '',
         redirectUri: redirectUri || '',
         scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
         baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index e0b9263..56e09d1 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -2,7 +2,7 @@ import type { UserInfo } from '../../types/authentik';
 
 interface AuthentikClientConfig {
   clientId: string;
-  clientSecret?: string;
+  clientSecret: string;
   redirectUri: string;
   scopes: string;
   baseUrl: string;
@@ -28,6 +28,9 @@ export function createClient(config: AuthentikClientConfig) {
   if (!baseUrl) {
     throw new Error('Authentik base URL is required');
   }
+  if (!clientSecret) {
+    throw new Error('Client secret is required for this Authentik application');
+  }
 
   const login = async (originalUrl?: string) => {
     try {
@@ -44,12 +47,10 @@ export function createClient(config: AuthentikClientConfig) {
           ? window.location.pathname + window.location.search 
           : '/');
 
-      console.error('DEBUG LOGIN - Storing URL:', {
+      console.log('DEBUG LOGIN - Storing URL:', {
         originalUrl,
         currentUrl,
-        windowLocation: typeof window !== 'undefined' ? window.location.href : 'No window',
-        pathname: typeof window !== 'undefined' ? window.location.pathname : 'No window',
-        search: typeof window !== 'undefined' ? window.location.search : 'No window'
+        windowLocation: typeof window !== 'undefined' ? window.location.href : 'No window'
       });
 
       // Construct the authorization URL
@@ -85,28 +86,23 @@ export function createClient(config: AuthentikClientConfig) {
       // Exchange authorization code for tokens
       const tokenUrl = new URL(`${sanitizedBaseUrl}/application/o/token/`);
       
-      console.error('DEBUG TOKEN EXCHANGE:', {
+      console.log('DEBUG TOKEN EXCHANGE:', {
         tokenUrl: tokenUrl.toString(),
         clientId,
         redirectUri,
         code: code ? 'Code Present' : 'No Code',
-        baseUrl: sanitizedBaseUrl,
-        hasClientSecret: !!clientSecret
+        baseUrl: sanitizedBaseUrl
       });
 
       // Prepare token exchange parameters
       const tokenParams = new URLSearchParams({
         client_id: clientId,
+        client_secret: clientSecret,
         redirect_uri: redirectUri,
         grant_type: 'authorization_code',
         code: code,
       });
 
-      // Add client secret for confidential clients
-      if (clientSecret) {
-        tokenParams.set('client_secret', clientSecret);
-      }
-
       const tokenResponse = await fetch(tokenUrl.toString(), {
         method: 'POST',
         headers: {
@@ -199,7 +195,7 @@ export function createClient(config: AuthentikClientConfig) {
 
       return null;
     } catch (error) {
-      console.error('Failed to retrieve user info:', error);
+      console.error('Failed to get user info:', error);
       return null;
     }
   };
@@ -208,6 +204,6 @@ export function createClient(config: AuthentikClientConfig) {
     login,
     handleCallback,
     logout,
-    getUserInfo,
+    getUserInfo
   };
 }
diff --git a/src/pages/callback.astro b/src/pages/callback.astro
index f5e69e7..0d332d2 100644
--- a/src/pages/callback.astro
+++ b/src/pages/callback.astro
@@ -20,15 +20,26 @@ import Layout from '../layouts/BaseLayout.astro';
 
         if (!code) {
           console.error('No authorization code found');
-          return;
+          throw new Error('No authorization code present in the URL');
         }
 
+        // Log detailed debug information
+        console.log('Authentication Callback Debug:', {
+          code: code ? 'Code Present' : 'No Code',
+          origin: window.location.origin,
+          fullUrl: window.location.href,
+          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID ? 'Present' : 'Missing',
+          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
+          redirectUri: `${window.location.origin}/callback`
+        });
+
         // Import the Authentik client dynamically
         const { createClient } = await import('../lib/authentik/client');
 
         // Create the Authentik client with the same configuration used in TopBar
         const client = createClient({
           clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
+          clientSecret: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_SECRET || '',
           redirectUri: `${window.location.origin}/callback`,
           scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
           baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
@@ -36,9 +47,24 @@ import Layout from '../layouts/BaseLayout.astro';
         });
 
         // Handle the callback
-        await client.handleCallback(code);
-      } catch (error) {
-        console.error('Authentication callback failed:', error);
+        const userInfo = await client.handleCallback(code);
+        
+        console.log('Authentication Successful:', userInfo);
+      } catch (error: unknown) {
+        const errorDetails = error instanceof Error 
+          ? {
+              errorName: error.name,
+              errorMessage: error.message,
+              errorStack: error.stack
+            }
+          : {
+              errorName: 'Unknown Error',
+              errorMessage: String(error),
+              errorStack: null
+            };
+
+        console.error('Authentication callback failed:', errorDetails);
+
         // Fallback redirect if something goes wrong
         window.location.href = '/';
       }

commit dece5b24ea9a1905a7a3c5d3f034ace43972aa9c
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 16:43:31 2025 +0800

    fixed sidebar

diff --git a/src/components/panels/Sidebar.astro b/src/components/panels/Sidebar.astro
index b52a372..f9b2f23 100644
--- a/src/components/panels/Sidebar.astro
+++ b/src/components/panels/Sidebar.astro
@@ -82,9 +82,9 @@ const { class: className, ...props } = Astro.props;
 
   // Get the current layout from panels in the state
   const getCurrentLayout = () => {
-    const state = store.getState();
+    const state = store.getState() as any;
     // Look at the panel configuration to determine which layout is active
-    const panels = state.panellayout.panels;
+    const panels = state.panellayout.panels || { right: { type: 'TodoPanel' } };
     if (panels.right.type === 'GeneratePanel') return 'generate_layout';
     return 'todo_layout';
   };
diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index 2e68311..e0b9263 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -2,6 +2,7 @@ import type { UserInfo } from '../../types/authentik';
 
 interface AuthentikClientConfig {
   clientId: string;
+  clientSecret?: string;
   redirectUri: string;
   scopes: string;
   baseUrl: string;
@@ -16,6 +17,7 @@ export function createClient(config: AuthentikClientConfig) {
 
   const { 
     clientId, 
+    clientSecret, 
     redirectUri, 
     scopes, 
     baseUrl, 
@@ -83,21 +85,44 @@ export function createClient(config: AuthentikClientConfig) {
       // Exchange authorization code for tokens
       const tokenUrl = new URL(`${sanitizedBaseUrl}/application/o/token/`);
       
+      console.error('DEBUG TOKEN EXCHANGE:', {
+        tokenUrl: tokenUrl.toString(),
+        clientId,
+        redirectUri,
+        code: code ? 'Code Present' : 'No Code',
+        baseUrl: sanitizedBaseUrl,
+        hasClientSecret: !!clientSecret
+      });
+
+      // Prepare token exchange parameters
+      const tokenParams = new URLSearchParams({
+        client_id: clientId,
+        redirect_uri: redirectUri,
+        grant_type: 'authorization_code',
+        code: code,
+      });
+
+      // Add client secret for confidential clients
+      if (clientSecret) {
+        tokenParams.set('client_secret', clientSecret);
+      }
+
       const tokenResponse = await fetch(tokenUrl.toString(), {
         method: 'POST',
         headers: {
           'Content-Type': 'application/x-www-form-urlencoded',
         },
-        body: new URLSearchParams({
-          client_id: clientId,
-          redirect_uri: redirectUri,
-          grant_type: 'authorization_code',
-          code: code,
-        }),
+        body: tokenParams,
       });
 
       if (!tokenResponse.ok) {
-        throw new Error('Failed to exchange authorization code');
+        const errorText = await tokenResponse.text();
+        console.error('Token Exchange Error:', {
+          status: tokenResponse.status,
+          statusText: tokenResponse.statusText,
+          errorBody: errorText
+        });
+        throw new Error(`Failed to exchange authorization code: ${errorText}`);
       }
 
       const tokens = await tokenResponse.json();

commit 521608029cddcc434a1520f878a65993212292b8
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 15:11:45 2025 +0800

    working log in

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 4bedbab..d7755fd 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -42,6 +42,11 @@ export const TopBar: React.FC = () => {
     try {
       setLoading(true);
       
+      // Get the full current path, including any query parameters
+      const currentPath = typeof window !== 'undefined' 
+        ? window.location.pathname + window.location.search 
+        : '/';
+
       // Log the environment variables to debug
       console.log('Authentik Config:', {
         clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID,
@@ -49,6 +54,7 @@ export const TopBar: React.FC = () => {
         scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES,
         baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
         storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+        currentPath,
       });
 
       const client = createClient({
@@ -59,7 +65,7 @@ export const TopBar: React.FC = () => {
         storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
       });
 
-      await client.login();
+      await client.login(currentPath);
     } catch (error) {
       console.error('Login failed:', error);
       setLoading(false);
diff --git a/src/layouts/BaseLayout.astro b/src/layouts/BaseLayout.astro
index 91fbf25..e3a406b 100644
--- a/src/layouts/BaseLayout.astro
+++ b/src/layouts/BaseLayout.astro
@@ -1,18 +1,16 @@
---- 
+---
 // src/layouts/BaseLayout.astro 
+import '../styles/global.css';
+
 const { title } = Astro.props; 
 ---  
-<html>   
+<html lang="en">   
 	<head>     
-		<title>{title}</title>   
+		<meta charset="utf-8" />
+		<meta name="viewport" content="width=device-width, initial-scale=1" />
+		<title>{title}</title>
 	</head>   
-	<body>     
-		<header>       
-			<h1>{title}</h1>     
-		</header>     
-		<main>       
-			<slot />     
-		</main>     
-		<footer>&copy; 2025 My Website</footer>   
+	<body class="bg-background text-foreground">     
+		<slot />     
 	</body> 
 </html>
\ No newline at end of file
diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index 1980f61..2e68311 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -27,7 +27,7 @@ export function createClient(config: AuthentikClientConfig) {
     throw new Error('Authentik base URL is required');
   }
 
-  const login = async () => {
+  const login = async (originalUrl?: string) => {
     try {
       // Ensure baseUrl is a string and remove trailing slashes
       const sanitizedBaseUrl = (baseUrl || '').toString().replace(/\/+$/, '');
@@ -36,6 +36,20 @@ export function createClient(config: AuthentikClientConfig) {
         throw new Error('Invalid Authentik base URL');
       }
 
+      // Use provided original URL or current window location
+      const currentUrl = originalUrl || 
+        (typeof window !== 'undefined' 
+          ? window.location.pathname + window.location.search 
+          : '/');
+
+      console.error('DEBUG LOGIN - Storing URL:', {
+        originalUrl,
+        currentUrl,
+        windowLocation: typeof window !== 'undefined' ? window.location.href : 'No window',
+        pathname: typeof window !== 'undefined' ? window.location.pathname : 'No window',
+        search: typeof window !== 'undefined' ? window.location.search : 'No window'
+      });
+
       // Construct the authorization URL
       const authorizationUrl = `${sanitizedBaseUrl}/application/o/authorize/`;
       
@@ -46,8 +60,8 @@ export function createClient(config: AuthentikClientConfig) {
       url.searchParams.set('response_type', 'code');
       url.searchParams.set('scope', scopes);
       
-      // Store the current URL to return after authentication
-      localStorage.setItem(`${storageKey}redirect_uri`, window.location.href);
+      // Store the original URL to return after authentication
+      localStorage.setItem(`${storageKey}redirect_uri`, currentUrl);
 
       // Redirect to Authentik login
       window.location.href = url.toString();
@@ -107,6 +121,11 @@ export function createClient(config: AuthentikClientConfig) {
       const userInfo = await userInfoResponse.json();
       localStorage.setItem(`${storageKey}user_info`, JSON.stringify(userInfo));
 
+      // Redirect to the specific page
+      if (typeof window !== 'undefined') {
+        window.location.href = `${window.location.origin}/Page`;
+      }
+
       return userInfo;
     } catch (error) {
       console.error('Authentication callback failed:', error);
@@ -162,8 +181,8 @@ export function createClient(config: AuthentikClientConfig) {
 
   return {
     login,
+    handleCallback,
     logout,
     getUserInfo,
-    handleCallback,
   };
 }
diff --git a/src/pages/callback.astro b/src/pages/callback.astro
index 93dfb90..f5e69e7 100644
--- a/src/pages/callback.astro
+++ b/src/pages/callback.astro
@@ -11,7 +11,40 @@ import Layout from '../layouts/BaseLayout.astro';
   </div>
 
   <script>
-    // Redirect back to the auth-example page
-    window.location.href = '/auth-example';
+    // Function to handle the authentication callback
+    async function handleAuthCallback() {
+      try {
+        // Extract the authorization code from the URL
+        const urlParams = new URLSearchParams(window.location.search);
+        const code = urlParams.get('code');
+
+        if (!code) {
+          console.error('No authorization code found');
+          return;
+        }
+
+        // Import the Authentik client dynamically
+        const { createClient } = await import('../lib/authentik/client');
+
+        // Create the Authentik client with the same configuration used in TopBar
+        const client = createClient({
+          clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
+          redirectUri: `${window.location.origin}/callback`,
+          scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
+          baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
+          storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+        });
+
+        // Handle the callback
+        await client.handleCallback(code);
+      } catch (error) {
+        console.error('Authentication callback failed:', error);
+        // Fallback redirect if something goes wrong
+        window.location.href = '/';
+      }
+    }
+
+    // Run the callback handler when the page loads
+    handleAuthCallback();
   </script>
 </Layout>
diff --git a/src/pages/index.astro b/src/pages/index.astro
index 12c6691..7942e3b 100644
--- a/src/pages/index.astro
+++ b/src/pages/index.astro
@@ -1,66 +1,5 @@
 ---
-// src/pages/index.astro 
-import ResizablePanelLayout from '../layouts/ResizablePanelLayout.astro';
-import { DynamicPanel } from '../components/DynamicPanel';
-
-// Define the panel configuration
-const panels = [
-  {
-    type: 'DemoLeftPanel',
-    slot: 'left',
-    sliceName: 'leftPanel',
-  },
-  {
-    type: 'DemoMainPanel',
-    slot: 'main',
-    sliceName: 'mainPanel',
-  },
-  {
-    type: 'DemoRightPanel',
-    slot: 'right',
-    sliceName: 'rightPanel',
-  },
-  {
-    type: 'ContentDetail',
-    slot: 'detail',
-    sliceName: 'contentDetail',
-  }
-];
+import DefaultLayout from '../layouts/DefaultLayout.astro';
 ---
 
-<ResizablePanelLayout>
-  <DynamicPanel
-    client:load
-    panelType="DemoLeftPanel"
-    slot="left"
-    sliceName="leftPanel"
-  />
-  
-  <DynamicPanel
-    client:load
-    panelType="DemoMainPanel"
-    slot="main"
-    sliceName="mainPanel"
-  />
-  
-  <DynamicPanel
-    client:load
-    panelType="DemoRightPanel"
-    slot="right"
-    sliceName="rightPanel"
-  />
-  
-  <DynamicPanel
-    client:load
-    panelType="ContentDetail"
-    slot="detail"
-    sliceName="contentDetail"
-  />
-</ResizablePanelLayout>
-
-<style is:global>
-  :root {
-    --panel-gap: 0.5rem;
-    --panel-padding: 1rem;
-  }
-</style>
\ No newline at end of file
+<DefaultLayout title="Redux Todo App" />

commit 28015f08f186a578055bae2b897e3585fb80eae7
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 14:50:08 2025 +0800

    working login

diff --git a/src/components/panels/TopBar.tsx b/src/components/panels/TopBar.tsx
index 8047b43..4bedbab 100644
--- a/src/components/panels/TopBar.tsx
+++ b/src/components/panels/TopBar.tsx
@@ -2,36 +2,30 @@ import React, { useState, useEffect, useCallback } from 'react';
 import { FiSun, FiMoon } from 'react-icons/fi';
 import { store } from '../../store';
 import { toggleTheme } from '../../features/themeSlice';
-import AuthentikPanel from '../auth/AuthentikPanel';
-import type { 
-  AuthentikPanelProps, 
-  UserInfo, 
-  AuthentikConfig 
-} from '../../types/authentik';
+import { createClient } from '../../lib/authentik/client';
 
 export const TopBar: React.FC = () => {
+  const [isClient, setIsClient] = useState(false);
   const [theme, setTheme] = useState(() => {
-    // Use a function to ensure this only runs on the client
     if (typeof window !== 'undefined') {
       return store.getState().theme?.mode || 'light';
     }
-    return 'light'; // Default server-side value
+    return 'light';
   });
-  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);
+  const [loading, setLoading] = useState(false);
   const [redirectUri, setRedirectUri] = useState('');
-  const [isClient, setIsClient] = useState(false);
 
   useEffect(() => {
-    // Ensure this only runs on the client
     setIsClient(true);
     
     if (typeof window !== 'undefined') {
-      setRedirectUri(`${window.location.origin}/callback`);
+      const origin = window.location.origin;
+      const path = '/callback'; // Ensure this matches your Authentik redirect configuration
+      setRedirectUri(`${origin}${path}`);
     }
   }, []);
 
   useEffect(() => {
-    // Subscribe to theme changes
     const unsubscribeTheme = store.subscribe(() => {
       const currentTheme = store.getState().theme?.mode;
       if (currentTheme && currentTheme !== theme) {
@@ -44,101 +38,32 @@ export const TopBar: React.FC = () => {
     };
   }, []);
 
-  const handleThemeToggle = () => {
-    store.dispatch(toggleTheme());
-  };
-
-  const renderUserAvatar = (info?: UserInfo) => {
-    if (info?.picture) {
-      return (
-        <img 
-          src={info.picture} 
-          alt={info.name || 'User'} 
-          className="w-8 h-8 rounded-full object-cover"
-        />
-      );
-    }
-
-    return (
-      <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
-        {info?.name ? info.name.charAt(0).toUpperCase() : '👤'}
-      </div>
-    );
-  };
+  const handleLogin = async () => {
+    try {
+      setLoading(true);
+      
+      // Log the environment variables to debug
+      console.log('Authentik Config:', {
+        clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID,
+        redirectUri,
+        scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES,
+        baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL,
+        storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+      });
 
-  const authentikConfig: AuthentikConfig = {
-    clientId: import.meta.env.AUTHENTIK_CLIENT_ID,
-    redirectUri: redirectUri || '/callback', // Fallback for SSR
-    scopes: import.meta.env.AUTHENTIK_SCOPES,
-    baseUrl: import.meta.env.AUTHENTIK_URL,
-    storageKey: `${import.meta.env.AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_bar_auth`,
-  };
+      const client = createClient({
+        clientId: import.meta.env.PUBLIC_AUTHENTIK_CLIENT_ID || '',
+        redirectUri: redirectUri || '',
+        scopes: import.meta.env.PUBLIC_AUTHENTIK_SCOPES || 'openid profile email',
+        baseUrl: import.meta.env.PUBLIC_AUTHENTIK_URL || '',
+        storageKey: `${import.meta.env.PUBLIC_AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
+      });
 
-  const authentikPanelProps: AuthentikPanelProps = {
-    config: authentikConfig,
-    renderUserInfo: (info: UserInfo | null) => {
-      setUserInfo(info);
-      if (!info) return null;
-      
-      return (
-        <div className="flex items-center space-x-2">
-          {renderUserAvatar(info)}
-          <div className="hidden md:block">
-            <p className="text-sm font-medium text-foreground">
-              {info.name || 'Guest'}
-            </p>
-            <p className="text-xs text-muted-foreground">
-              {info.email ? info.email.split('@')[0] : 'Not logged in'}
-            </p>
-          </div>
-        </div>
-      );
-    },
-    customLoginButton: useCallback((handleLogin: (...args: any[]) => void | Promise<void>, loading: boolean) => (
-      <button 
-        onClick={() => {
-          if (typeof handleLogin === 'function') {
-            const result = handleLogin();
-            if (result instanceof Promise) {
-              result.catch(console.error);
-            }
-          }
-        }}
-        disabled={loading}
-        className={`
-          flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
-          ${loading 
-            ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
-            : 'bg-blue-100 text-blue-600 hover:bg-blue-200'}
-        `}
-        aria-label="Sign In"
-      >
-        {loading ? 'Signing In...' : 'Sign In'}
-      </button>
-    ), []),
-    customLogoutButton: useCallback((handleLogout: (...args: any[]) => void | Promise<void>, loading: boolean) => (
-      <button 
-        onClick={() => {
-          if (typeof handleLogout === 'function') {
-            const result = handleLogout();
-            if (result instanceof Promise) {
-              result.catch(console.error);
-            }
-          }
-        }}
-        disabled={loading}
-        className={`
-          flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
-          ${loading 
-            ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
-            : 'hover:bg-gray-200'}
-        `}
-        aria-label="Logout"
-      >
-        {loading ? 'Signing Out...' : 'Sign Out'}
-      </button>
-    ), []),
-    'client:only': 'react',
+      await client.login();
+    } catch (error) {
+      console.error('Login failed:', error);
+      setLoading(false);
+    }
   };
 
   // Only render client-side specific content when on the client
@@ -157,12 +82,22 @@ export const TopBar: React.FC = () => {
       <div className="flex items-center space-x-4">
         <h1 className="text-xl font-semibold text-foreground">Redux Todo App</h1>
       </div>
-      
       <div className="flex items-center space-x-4">
-        <AuthentikPanel {...authentikPanelProps} />
-        
         <button 
-          onClick={handleThemeToggle}
+          onClick={handleLogin}
+          disabled={loading}
+          className={`
+            flex items-center justify-center px-3 py-1 rounded-full transition-colors text-sm font-medium
+            ${loading 
+              ? 'bg-gray-200 text-gray-500 cursor-not-allowed' 
+              : 'bg-blue-100 text-blue-600 hover:bg-blue-200'}
+          `}
+          aria-label="Sign In"
+        >
+          {loading ? 'Signing In...' : 'Sign In'}
+        </button>
+        <button 
+          onClick={() => store.dispatch(toggleTheme())}
           className="text-foreground hover:text-foreground/80"
           aria-label="Toggle theme"
         >
diff --git a/src/lib/authentik/client.ts b/src/lib/authentik/client.ts
index 7833319..1980f61 100644
--- a/src/lib/authentik/client.ts
+++ b/src/lib/authentik/client.ts
@@ -9,6 +9,11 @@ interface AuthentikClientConfig {
 }
 
 export function createClient(config: AuthentikClientConfig) {
+  // Validate config
+  if (!config) {
+    throw new Error('Authentik client configuration is required');
+  }
+
   const { 
     clientId, 
     redirectUri, 
@@ -17,20 +22,35 @@ export function createClient(config: AuthentikClientConfig) {
     storageKey 
   } = config;
 
+  // Validate individual config parameters
+  if (!baseUrl) {
+    throw new Error('Authentik base URL is required');
+  }
+
   const login = async () => {
     try {
+      // Ensure baseUrl is a string and remove trailing slashes
+      const sanitizedBaseUrl = (baseUrl || '').toString().replace(/\/+$/, '');
+
+      if (!sanitizedBaseUrl) {
+        throw new Error('Invalid Authentik base URL');
+      }
+
       // Construct the authorization URL
-      const authorizationUrl = new URL(`${baseUrl}/application/o/authorize/`);
-      authorizationUrl.searchParams.set('client_id', clientId);
-      authorizationUrl.searchParams.set('redirect_uri', redirectUri);
-      authorizationUrl.searchParams.set('response_type', 'code');
-      authorizationUrl.searchParams.set('scope', scopes);
+      const authorizationUrl = `${sanitizedBaseUrl}/application/o/authorize/`;
+      
+      // Create URL with search params
+      const url = new URL(authorizationUrl);
+      url.searchParams.set('client_id', clientId);
+      url.searchParams.set('redirect_uri', redirectUri);
+      url.searchParams.set('response_type', 'code');
+      url.searchParams.set('scope', scopes);
       
       // Store the current URL to return after authentication
       localStorage.setItem(`${storageKey}redirect_uri`, window.location.href);
 
       // Redirect to Authentik login
-      window.location.href = authorizationUrl.toString();
+      window.location.href = url.toString();
     } catch (error) {
       console.error('Login initialization failed:', error);
       throw error;
@@ -39,8 +59,15 @@ export function createClient(config: AuthentikClientConfig) {
 
   const handleCallback = async (code: string) => {
     try {
+      // Ensure baseUrl is a string and remove trailing slashes
+      const sanitizedBaseUrl = (baseUrl || '').toString().replace(/\/+$/, '');
+
+      if (!sanitizedBaseUrl) {
+        throw new Error('Invalid Authentik base URL');
+      }
+
       // Exchange authorization code for tokens
-      const tokenUrl = new URL(`${baseUrl}/application/o/token/`);
+      const tokenUrl = new URL(`${sanitizedBaseUrl}/application/o/token/`);
       
       const tokenResponse = await fetch(tokenUrl.toString(), {
         method: 'POST',
@@ -66,7 +93,7 @@ export function createClient(config: AuthentikClientConfig) {
       localStorage.setItem(`${storageKey}id_token`, tokens.id_token);
 
       // Fetch user info
-      const userInfoUrl = new URL(`${baseUrl}/application/o/userinfo/`);
+      const userInfoUrl = new URL(`${sanitizedBaseUrl}/application/o/userinfo/`);
       const userInfoResponse = await fetch(userInfoUrl.toString(), {
         headers: {
           'Authorization': `Bearer ${tokens.access_token}`,
@@ -89,17 +116,24 @@ export function createClient(config: AuthentikClientConfig) {
 
   const logout = async () => {
     try {
+      // Ensure baseUrl is a string and remove trailing slashes
+      const sanitizedBaseUrl = (baseUrl || '').toString().replace(/\/+$/, '');
+
+      if (!sanitizedBaseUrl) {
+        throw new Error('Invalid Authentik base URL');
+      }
+
       // Remove stored tokens and user info
       localStorage.removeItem(`${storageKey}access_token`);
       localStorage.removeItem(`${storageKey}id_token`);
       localStorage.removeItem(`${storageKey}user_info`);
 
       // Construct logout URL
-      const logoutUrl = new URL(`${baseUrl}/application/o/end-session/`);
+      const logoutUrl = new URL(`${sanitizedBaseUrl}/application/o/end-session/`);
       logoutUrl.searchParams.set('client_id', clientId);
       logoutUrl.searchParams.set('post_logout_redirect_uri', redirectUri);
 
-      // Redirect to logout endpoint
+      // Redirect to logout
       window.location.href = logoutUrl.toString();
     } catch (error) {
       console.error('Logout failed:', error);
diff --git a/src/store.ts b/src/store.ts
new file mode 100644
index 0000000..35b2ab2
--- /dev/null
+++ b/src/store.ts
@@ -0,0 +1,11 @@
+import { configureStore } from '@reduxjs/toolkit';
+import themeReducer from './features/themeSlice';
+
+export const store = configureStore({
+  reducer: {
+    theme: themeReducer,
+  },
+});
+
+export type RootState = ReturnType<typeof store.getState>;
+export type AppDispatch = typeof store.dispatch;

commit 2c644cfd74448984ea462d3ed4df53729bda6607
Author: Henrykoo <lckoo1230@gmail.com>
Date:   Sun Mar 16 13:34:12 2025 +0800

    better astro topbanner

diff --git a/src/components/panels/TopBanner.astro b/src/components/panels/TopBanner.astro
index af928dc..802f2da 100644
--- a/src/components/panels/TopBanner.astro
+++ b/src/components/panels/TopBanner.astro
@@ -2,7 +2,6 @@
 import { FiSun, FiMoon } from 'react-icons/fi';
 import { store } from '../../store';
 import { cn } from '../../utils/cn';
-import AuthentikPanel from '../auth/AuthentikPanel';
 
 // Get initial theme mode from store
 const themeMode = store.getState().theme?.mode || 'light';
@@ -26,138 +25,6 @@ const {
   <div class="flex justify-between items-center w-full">
     <h1 class="text-xl font-semibold text-foreground">Redux Todo App</h1>
     <div class="flex items-center space-x-4">
-      <AuthentikPanel 
-        client:only={true}
-        config={{
-          clientId: import.meta.env.AUTHENTIK_CLIENT_ID,
-          redirectUri: `${Astro.url.protocol}//${Astro.url.host}/callback`,
-          scopes: import.meta.env.AUTHENTIK_SCOPES,
-          baseUrl: import.meta.env.AUTHENTIK_URL,
-          storageKey: `${import.meta.env.AUTHENTIK_STORAGE_KEY_PREFIX || 'authentik_'}top_banner_auth`,
-        }}
-        renderUserInfo={(userInfo) => (
-          <div class="flex items-center space-x-2">
-            {userInfo?.picture ? (
-              <img 
-                src={userInfo.picture} 
-                alt={userInfo.name || 'User'} 
-                class="w-8 h-8 rounded-full object-cover"
-              />
-            ) : (
-              <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
-                {userInfo?.name ? userInfo.name.charAt(0).toUpperCase() : ''}
-              </div>
-            )}
-            <div class="hidden md:block">
-              <p class="text-sm font-medium text-foreground">
-                {userInfo?.name || 'Guest'}
-              </p>
-              <p class="text-xs text-muted-foreground">
-                {userInfo?.email ? userInfo.email.split('@')[0] : 'Not logged in'}
-              </p>
-            </div>
-          </div>
-        )}
-        customLoginButton={(isLoading) => (
-          <button 
-            disabled={isLoading}
-            class={cn(
-              "flex items-center justify-center w-8 h-8 rounded-full transition-colors",
-              isLoading 
-                ? "bg-gray-200 cursor-not-allowed" 
-                : "bg-blue-100 text-blue-600 hover:bg-blue-200"
-            )}
-            aria-label="Login"
-          >
-            {isLoading ? (
-              <svg 
-                xmlns="http://www.w3.org/2000/svg" 
-                className="animate-spin h-5 w-5 text-blue-600" 
-                fill="none"
-                viewBox="0 0 24 24"
-              >
-                <circle 
-                  className="opacity-25" 
-                  cx="12" 
-                  cy="12" 
-                  r="10" 
-                  stroke="currentColor" 
-                  strokeWidth="4"
-                />
-                <path 
-                  className="opacity-75" 
-                  fill="currentColor" 
-                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
-                />
-              </svg>
-            ) : (
-              <svg 
-                xmlns="http://www.w3.org/2000/svg" 
-                className="h-5 w-5" 
-                fill="none"
-                viewBox="0 0 24 24"
-                stroke="currentColor"
-                strokeWidth="2"
-                strokeLinecap="round"
-                strokeLinejoin="round"
-              >
-                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
-                <circle cx="12" cy="7" r="4" />
-              </svg>
-            )}
-          </button>
-        )}
-        customLogoutButton={(isLoading) => (
-          <button 
-            disabled={isLoading}
-            class={cn(
-              "flex items-center justify-center w-8 h-8 rounded-full transition-colors",
-              isLoading 
-                ? "bg-gray-200 cursor-not-allowed" 
-                : "hover:bg-gray-200"
-            )}
-            aria-label="Logout"
-          >
-            {isLoading ? (
-              <svg 
-                xmlns="http://www.w3.org/2000/svg" 
-                className="animate-spin h-5 w-5 text-gray-600" 
-                fill="none"
-                viewBox="0 0 24 24"
-              >
-                <circle 
-                  className="opacity-25" 
-                  cx="12" 
-                  cy="12" 
-                  r="10" 
-                  stroke="currentColor" 
-                  strokeWidth="4"
-                />
-                <path 
-                  className="opacity-75" 
-                  fill="currentColor" 
-                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
-                />
-              </svg>
-            ) : (
-              <svg 
-                xmlns="http://www.w3.org/2000/svg" 
-                className="h-5 w-5 text-gray-600" 
-                fill="none"
-                viewBox="0 0 24 24"
-                stroke="currentColor"
-                strokeWidth="2"
-                strokeLinecap="round"
-                strokeLinejoin="round"
-              >
-                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
-                <polyline points="16 17 21 12 16 7" />
-                <line x1="21" y1="12" x2="9" y2="12" />
-              </svg>
-            )}
-          </button>
-        )}
-      />
       <button 
         onclick="window.handleThemeToggle()"
         class="text-foreground hover:text-foreground/80"
@@ -173,8 +40,7 @@ const {
   </div>
 </div>
 
-<script>
-  import { store } from '../../store';
+<script define:vars={{store}}>
   import { toggleTheme } from '../../features/themeSlice';
 
   // Define the theme toggle function in the client-side script
```
